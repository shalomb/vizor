@echo off

setlocal enabledelayedexpansion

@echo.
@echo.Razor second-stage Windows installer script starting
@echo.

set server=<%= URI.parse(repo_url).host %>
set share=razor
set repo=<%= repo_url.split('/').last %>
set installer=\\!server!\!share!\!repo!\setup.exe
set answerfile_src=<%= file_url('unattended.xml') %>
set answerfile=unattended.xml

@echo.
@echo.Fetching the !answerfile_src! file to feed the installer
@echo.

pause
cd !SYSTEMDRIVE!
curl !answerfile_src! -o !answerfile!

@echo.Mapping SMB share \\!server!\!share! for installer access
net use \\!server!\!share!

@echo.Starting installer !installer!
pause

!installer! /unattend:!answerfile! /noreboot

@echo.Notify Razor that the installer completed
curl <%= stage_done_url('finished') %>

@echo.Restarting the system to complete installation

pause
