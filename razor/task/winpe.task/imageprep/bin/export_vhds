#!/bin/bash

xe template-list other-config:instant=true | \
  xe_grep 'print uuid,name_label if name_label =~ /(?:ASF|\d+$)/' | \
  while read uuid name; do 
    echo; 
    echo "Name: $name"; 
    vdi=($(xe vbd-list vm-uuid="$uuid" type=Disk params=vdi-uuid --minimal | sed 's/,/\n/g')); 
    for v in ${!vdi[@]}; do 
      vdi_uuid="${vdi[$v]}"; 
      printf "  vm(%s,%-24s) disk($v) vdi(%s)\n" "$uuid" "$name" "$v" "${vdi_uuid}";
      sr_uuid=$(xe vdi-list uuid="$vdi_uuid" params=sr-uuid --minimal);
      if cd /var/run/sr-mount/"$sr_uuid"; then 
        mkdir -pv "vhd";
        new_vdi=$(xe vdi-copy uuid="$vdi_uuid" sr-uuid="$sr_uuid");
        echo "Cloned $vdi_uuid to $new_vdi";
        ln "$PWD/${new_vdi}.vhd" "$PWD/vhd/";
        cd vhd;
        pwd;
        ln -svf "$new_vdi.vhd" "${name}--$v--$(date +%s).vhd";
        ln -svf "$new_vdi.vhd" "${vdi_uuid}.vhd";
        [[ -e "$name.metadata.xml" ]] || xe vm-export vm="$uuid" metadata=true filename="$name.metadata.xml";
      fi
      echo;
    done;
  done
