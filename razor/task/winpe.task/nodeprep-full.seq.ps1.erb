# Powershell

# SYNOPSIS
#   nodeprep.seq.ps1 - perform vm preparation tasks

# DESCRIPTION
#   This script does not run directly but simply returns an object collection
#   down the pipeline for ImageMaintenance\Invoke-Task to act upon. The object
#   is an array of array of hashes - each hash defining the task (command) to
#   be run along with optional input criteria.

# Logs and transcripts are stored in %programdata%\imageprep

# Completion Criteria
#   All tasks must pass, sequence aborts if any fail
#   VM Guest/PV Tools must install
#   Windows Update must complete
#   Node must reboot 6 times

# Crash Dump Initialization Failed
#  'How to generate a kernel or a complete memory dump file in Windows Server 2008 and Windows Server 2008 R2'
#  http://support.microsoft.com/kb/969028
# Dump of Windows Updates, etc/v

[CmdletBinding()] Param()

Set-StrictMode -Version 2.0
Set-PSDebug -Trace 0

$ErrorActionPreference          = 'STOP'
$PSModuleAutoLoadingPreference  = 'None'

# Import all modules required by tasks defined below
Import-Module Microsoft.PowerShell.Host -ea 0 # Seems to fail import on PSv2
Import-Module CDROM
# Import-Module GroupPolicy
Import-Module MSRT
Import-Module SystemUtils
Import-Module TaskUtils
Import-Module VDIOptimizations
Import-Module WindowsActivation
Import-Module WindowsDefender
Import-Module WindowsUpdate
Import-Module WinMgmt
Import-Module DotNetFramework

Import-Module Logging    -Global
Import-Module Assertions -Global

# Define the environment for the run
# NOTE: Variable carrying powershell types (e.g. boolean, etc) do not
#       hold when evaluated (they are env. vars) later. Ensure a string cast!
$Env:WSUS_URL     = '<%= node.metadata["wsus_url"]    %>'
$Env:KMS_SERVER   = '<%= node.metadata["kms_server"]  %>'
$Env:KMS_PORT     = '<%= node.metadata["kms_server_port"] ||= 1688 %>'
$Env:NTP_SERVERS  = '<%= node.metadata["ntp_server_list"] ||= 'pool.ntp.org,time.windows.com,time.nis.gov' %>'

$Env:INSTALL_DOTNET35       = <%= node.metadata["install_dotnet35"]       ? '$True' : '$False' %>
$Env:INSTALL_WINDOWS_UPDATE = <%= node.metadata["install_windows_update"] ? '$True' : '$False' %>
$Env:ENABLE_SYSPREP         = <%= node.metadata["enable_sysprep"]         ? '$True' : '$False' %>

$Env:COMPUTER_DESCRIPTION = '<%= node.metadata["computer_description"] ||= node.metadata['vstring_long'] %>'

$Env:TIMEZONE     = '<%= node.metadata["windows_timezone"] ||= "GMT Standard Time" %>'
$Env:L18NXML_URL  = '<%= file_url('l18n.xml') %>'

$Env:AdministratorAccountName = '<%= node.metadata["admin_account_name" ||= "Administrator" %>'

$Env:PATH += ";$Env:IPBaseDir\bin;$Env:IPBaseDir\bin\SysInternals"
if ( (Test-Path "bin\SysInternals") ) { $Env:PATH += "$($PWD.ProviderPath)\bin\SysInternals;" }

$OSVersion = Get-OSVersion
$Env:CpuArchitecture    =  [System.String](Get-Cpu -Architecture)
$Env:CurrentBuild       =  [System.Double]$OSVersion.CurrentBuild
$Env:CurrentVersion     =  [System.Double]$OSVersion.CurrentVersion
$Env:InstallationType   =  [System.String]$OSVersion.InstallationType
$Env:OSArchitecture     =  [System.String]$OSVersion.OSArchitecture
$Env:OSCaptionAlt       =  [System.String]$OSVersion.CaptionAlt
$Env:OSCaption          =  [System.String]$OSVersion.Caption
$Env:OSType             =  [System.String]$OSVersion.OSType
$Env:OSVersionMajor     = ([System.Version]$OSVersion.Version).Major
$Env:OSVersionMinor     = ([System.Version]$OSVersion.Version).Minor
$Env:OSVersionString    =  [System.String]$OSVersion.VersionString
$Env:OSVersion          =  [System.Version]$OSVersion.Version
$Env:ProductName        =  [System.String]$OSVersion.ProductName
$Env:PSVersion          =  [System.Version]$PSVersionTable.PSVersion
$Env:PSVersionMajor     = ([System.Version]$PSVersionTable.PSVersion).Major
$Env:PSVersionMinor     = ([System.Version]$PSVersionTable.PSVersion).Minor
$Env:ServicePackVersion =  [System.Version]$OSVersion.ServicePackVersion


# Stage 0
#   Prepare image
#   Install packages/roles
#   Install Windows updates
@(
  @{ name    =   "stage_0_begins-$(date -uformat %s)";
      script = { try { (New-Object Net.WebClient).DownloadString('<%= stage_done_url('stage_0_begins') %>') } catch{} };
      pre    = { 1 }; post   = { 1 }; }

  @{ name    =   "increase_priority_of_image_prep_processes-$(Get-Date -UFormat %s)";
      script = {
        # All Windows Update related process/services are set at priority class high
        $Pids = @()
        $Pids += @( Get-Process -Name *mscorsvw*,*powershell*,*worker*,*inst*,*pv*,*guest*,*wu* | Select -Expand Id )
        $Pids += @( Gwmi Win32_Service | ?{ $_.Name -imatch 'bits|clr|defrag|guest|inst|pv|trust|wu' } | Select -Expand ProcessId )

        foreach ($Id in $Pids) {
          try {
            Set-ProcessPriority -Id $Id -Priority 'High'
          } catch {
            Write-Warning "Failed to set priority for process '$Id' : $_"
          }
        }
      };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   "decrease_priority_of_unnecessary_windows_processes-$(Get-Date -UFormat %s)";
      script = {
        Get-Process -Name *Dwm*,*Search*,*WMP*,*Logon*,*init* | %{
          try {
            Set-ProcessPriority -Id $_.Id -Priority 'Idle'
          } catch {
            Write-Warning "Failed to set priority for process : $_"
          }
        }
      };
      pre    = { 1 }; post   = { 1 }; }

  @{ name    =   'start_w32tm_service_1';
      script = {  Get-Service -Name W32Time | Set-Service -StartupType Automatic -PassThru | Restart-Service };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'set_ntp_servers';
      script = { Set-NTPServers $Env:NTP_SERVERS -Verbose };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'sync_ntp_time_stage_0';
      script = { Sync-W32Time };
      pre    = { 1 }; post   = { 1 }; }

  @{ name    =   "uninstall_bootstrap_startup_script-$(date -uformat %s)";
      script = { Get-StartupCommand | ?{ $_.Command -imatch 'Start-BootStrap.cmd' } | Uninstall-StartupCommand -Verbose };
      pre    = { 1 }; post   = { 1 }; }

  @{ name    =   'rename_first_administrator_account';
      script = {
        Gwmi -Class Win32_UserAccount -Filter 'LocalAccount = TRUE' | ?{
          $_.SID -imatch '^S-1-5-21-.*500'
        } | %{
          $_.Rename($Env:AdministratorAccountName)
        }
      };
      pre    = { 1 }; post   = { 1 }; }

  @{ name    =   'install_powershell_taskbar_shortcut';
      script = { try{Install-DesktopShortcut -Label "PowerShell" -Command "$Env:WINDIR\System32\WindowsPowerShell\v1.0\powershell.exe"} catch {} };
      pre    = { 1; }; post   = { 1 }; }
  @{ name    =   'install_cmd_taskbar_shortcut';
      script = { try{Install-DesktopShortcut -Label "CMD" -Command "cmd.exe"} catch {} };
      pre    = { 1; }; post   = { 1 }; }
  @{ name    =   'install_taskmgr_taskbar_shortcut';
      script = { try{Install-DesktopShortcut -Label "TaskManager" -Command "taskmgr.exe"} catch{} };
      pre    = { 1; }; post   = { 1 }; }
  @{ name    =   'install_event_viewer_taskbar_shortcut';
      script = { try{Install-DesktopShortcut -Label "Event Viewer" -Command "eventvwr.exe"} catch{}};
      pre    = { 1; }; post   = { 1 }; }
  @{ name    =   'install_psr_taskbar_shortcut';
      script = { try{Install-DesktopShortcut -Label "Problem Steps Recorder" -Command "psr.exe"}catch{} };
      pre    = { 1; }; post   = { 1 }; }

  @{ name    =   'set_cscript_as_wsh_host';
      script = { Set-WSHScriptHost "CScript" };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'set_kms_server';
      script = { & slmgr.vbs -skms "${Env:KMS_SERVER}:${Env:KMS_PORT}" };
      pre    = {
        Assert-IsNotNull { $Env:KMS_SERVER } 'KMS Server hostname is not defined.'
        Assert-IsTrue    { [Double]$Env:CurrentVersion -ge 6.0 } 'OS CurrentVersion < 6.0, slmgr.vbs not available.'
      }; post   = { 1 }; }
  @{ name    =   'activate_windows';
      script = { Invoke-WindowsActivation };
      pre    = { 1 }; post   = { Get-WindowsActivation }; }

  @{ name    =   'install_show_desktop_on_logon_windows_8';
      script = {
        Install-GlobalLogonScript -Name 'ShowDesktopOnLogon' -Script 'explorer.exe "shell:::{3080F90D-D7AD-11D9-BD98-0000947B0257}"'
      };
      pre    = {
        Assert-IsTrue { $Env:CurrentVersion -eq 6.2 }        'OS CurrentVersion != 6.2'
        Assert-IsTrue { $Env:InstallationType -eq 'Client' } 'OS InstallationType != Client'
      };
      post   = { 1 }; }
  @{ name    =   'install_backup_show_desktop_on_logon_windows_8';
      script = {
$scf=@"
[Shell]
Command=2
IconFile=Explorer.exe,3
[Taskbar]
Command=ToggleDesktop
"@
        $scf | Out-File -ea 0 -Encoding ascii ($showDesktopCmd = Join-Path $PWD 'Show-Desktop.scf')
        Install-GlobalLogonScript -Name 'ShowDesktopOnLogonBackup' -Script $showDesktopCmd
      };
      pre    = {
        Assert-IsTrue { $Env:CurrentVersion -eq 6.2 }        'OS CurrentVersion != 6.2'
        Assert-IsTrue { $Env:InstallationType -eq 'Client' } 'OS InstallationType != Client'
      };
      post   = { 1 }; }
  @{ name    =   'disable_first_logon_animations';
      script = { try { Enable-FirstLogonAnimations } catch {} };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'install_ipconfig_registerdns_on_logon';
      script = {
        Install-GlobalLogonScript -Name 'IpconfigRegisterDnsOnLogon' -Script 'ipconfig.exe /registerdns'
      };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'set_computer_description';
      script = {  Set-ComputerDescription -Description $Env:COMPUTER_DESCRIPTION };
      pre    = { 1 }; post   = { 1 }; }

  @{ name    =   "enable_boot_training-$(Get-Date -UFormat %s)";
      script = {
        # 'Windows 7 Self Optimizing Boot Process - AutoIt Consulting'
        #   https://www.autoitconsulting.com/site/performance/windows-7-self-optimizing-boot-process/
        reg.exe add 'HKLM\SOFTWARE\Microsoft\Dfrg\BootOptimizeFunction'            /f /v Enable           /t REG_SZ    /d Y
        reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\OptimalLayout' /f /v EnableAutoLayout /t REG_DWORD /d 1
        try {
          # This is done to get around defrag failing with
          #   'Some registry entries were missing from the boot optimization section of the regitry. (0x89000017)'
          reg.exe delete 'HKLM\SOFTWARE\Microsoft\Dfrg\BootOptimizeFunction' /f /v OptimizeComplete
          reg.exe delete 'HKLM\SOFTWARE\Microsoft\Dfrg\BootOptimizeFunction' /f /v OptimizeError
        } catch {}
      };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   "set_defragsvc_startuptype_automatic-$(Get-Date -UFormat %s)";
      script = {
        Get-Service defragsvc -ea 0 | Set-Service -StartupType Automatic -PassThru | Restart-Service -Verbose:$VerbosePreference
      };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'enable_crash_control_crash_dump_full';
      script = { Enable-CrashControlCrashDump -Value 1 -Verbose:$VerbosePreference };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'enable_crash_control_nmi_crash_dump';
      script = { Enable-NMICrashDump -Verbose:$VerbosePreference };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'disable_auto_reboot_on_system_failure';
      script = { Disable-AutoRebootOnSystemFailure };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'enable_crash_control_autoreboot';
      script = { Enable-CrashControlAutoReboot -Verbose:$VerbosePreference };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'enable_crash_control_dump_file_overwrite';
      script = { Enable-CrashControlDumpFileOverWrite -Verbose:$VerbosePreference };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'enable_crash_control_send_alert';
      script = { Enable-CrashControlSendAlert -Verbose:$VerbosePreference };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'enable_crash_control_log_system_event';
      script = { Enable-CrashControlLogEvent -Verbose:$VerbosePreference };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'enable_crash_control_always_keep_memory_dump';
      script = { Enable-CrashControlAlwaysKeepMemoryDump -Verbose:$VerbosePreference };
      pre    = { 1 }; post   = { 1 }; }

  @{ name    =   'disable_first_logon_animations';
      script = { Disable-FirstLogonAnimations };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'disable_server_manager';
      script = {
        reg.exe add 'HKLM\SOFTWARE\Microsoft\ServerManager\Oobe' /f /v DoNotOpenInitialConfigurationTasksAtLogon /t REG_DWORD /d 1
        # reg.exe add 'HKLM\SOFTWARE\Microsoft\ServerManager'      /f /v DoNotOpenServerManagerAtLogon             /t REG_DWORD /d 1
      }
      pre    = {
        Assert-IsTrue { $Env:InstallationType -eq 'Server' } 'OS InstallationType != Server'
      };
      post   = { 1 }; }
  @{ name    =   'set_network_name_to_work';
      script = { Set-NetworkLocation -NetworkName 'Work' };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'disable_network_location_wizard';
      script = { Disable-NetworkLocationPrompt -Verbose:$VerbosePreference };
      pre    = { 1 }; post   = { 1 }; }

  @{ name    =   'uninstall_msmsgs_startup_commands';
      pre    = {
        Assert-IsTrue { $Env:CurrentVersion -eq 5.1 } 'OS CurrentVersion != 5.1'
      };
      script = { try { Get-StartupCommand | ?{ $_.Caption -imatch 'msmsgs' } | Uninstall-StartupCommand -Verbose:$VerbosePreference } catch {} }; post   = { 1 }; }
  @{ name    =   'uninstall_ctfmon_startup_commands';
      pre    = {
        Assert-IsTrue { $Env:CurrentVersion -eq 5.1 } 'OS CurrentVersion != 5.1'
      };
      script = { try { Get-StartupCommand | ?{ $_.Caption -imatch 'ctfmon.exe' } | Uninstall-StartupCommand -Verbose:$VerbosePreference }catch{}}; post   = { 1 }; }
  @{ name    =   'uninstall_welcomecenter_startup_commands';
      pre    = {
        Assert-IsTrue { $Env:CurrentVersion -imatch '^(?:5\.0|6\.0)' } 'OS CurrentVersion !~ (?:5\.0|6\.0)'
      };
      script = { try { Get-StartupCommand | ?{ $_.Caption -imatch 'welcomecenter' } | Uninstall-StartupCommand -Verbose:$VerbosePreference }catch{}}; post   = { 1 }; }
  @{ name    =   'uninstall_sidebar_startup_commands';
      pre    = {
        Assert-IsTrue { $Env:CurrentVersion -imatch '^6\.[01]' } 'OS CurrentVersion !~ 6\.[01]'
      };
      script = { try { Get-StartupCommand | ?{ $_.Caption -imatch 'sidebar' } | Uninstall-StartupCommand -Verbose:$VerbosePreference } catch{} }; post   = { 1 }; }
  @{ name    =   'uninstall_windows_defender_startup_commands';
      pre    = { 1 };
      script = { try { Get-StartupCommand | ?{ $_.Caption -imatch 'windows defender' } | Uninstall-StartupCommand -Verbose:$VerbosePreference } catch{} }; post   = { 1 }; }
  @{ name    =   'disable_windows_sidebar';
      script = { Disable-WindowsSidebar -Verbose:$VerbosePreference };
      pre    = {
        Assert-IsTrue { $Env:CurrentVersion -eq 6.0 } 'OS Currentversion != 6.0'
      };
      post   = { 1 }; }
  @{ name    =   'disable_screensaver';
      script = { Disable-ScreenSaver -Verbose:$VerbosePreference };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'initialize_sysinternals_tools';
      script = { SystemUtils\Initialize-SysInternals };
      pre    = { 1 }; post   = { 1 }; }

  @{ name    =   'disable_system_restore';
      script = { Disable-SystemResoreOnLocalDrives -ea 0 };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'create_l18n_prereqs';
      script = { try {
          # Create the necessary reg keys for Internationalization
          # These keys appear to be created by the OS sometime after firstboot
          # and are needed for language pack installs
          reg.exe add "HKCU\Control Panel\International" /f              | Write-Verbose
          reg.exe add "HKCU\Control Panel\International\User Profile" /f | Write-Verbose
        } catch {}
      };
      pre    = { 1 };
      post   = { 1 }; }
#  @{ name    =   'set_user_preferences';
#      script = {
#        try {
#          # TODO. The settings in this section are very questionable as defaults.
#          #       Review needed.
#          # TODO, Workaround. HKU:/ hive fails to load if the registry .dat file
#          #       is in use. Investigations and refactoring of cmdlet needed.
#          Set-UserPreferences -Verbose:$VerbosePreference 
#        } catch {
#          Write-Warning "Failed to set user preferences. Rebooting to retry."
#          Restart-Computer
#        }
#      };
#      pre    = { 1 }; post   = { 1 }; }
# @{ name    =   'disable_device_autorun';
#     script = { Disable-AutoRun };
#     pre    = { 1 }; post   = { 1 }; }

  @{ name    =   'set_powersheme_disable_hibernation';
      script = {  try { $Local:ErrorActionPreference = "CONTINUE"
        powercfg.exe -h off
        powercfg.exe -change -hibernate-timeout-ac 0
        powercfg.exe -change -hibernate-timeout-dc 0
      } catch {} };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'set_powerscheme_high_performance';
      script = {  try { $Local:ErrorActionPreference = "CONTINUE"
        powercfg.exe -s           8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        powercfg.exe -setabsentia 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        powercfg -setacvalueindex 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c fea3413e-7e05-4911-9a71-700331f1c294 245d8541-3943-4422-b025-13a784f679b7 1
        powercfg -setdcvalueindex 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c fea3413e-7e05-4911-9a71-700331f1c294 245d8541-3943-4422-b025-13a784f679b7 1
      } catch {} };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'set_powerscheme_always_on';
      script = {  try { $Local:ErrorActionPreference = "CONTINUE"
        powercfg.exe -setactive scheme_min
        powercfg.exe -setactive "Always On"
      } catch {} };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'set_powersheme_prevent_display_blanking';
      script = {  try { $Local:ErrorActionPreference = "CONTINUE"
        powercfg.exe -change -monitor-timeout-ac 0
      } catch {} };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'set_powersheme_standby_timout';
      script = {  try { $Local:ErrorActionPreference = "CONTINUE"
        powercfg.exe -change -standby-timeout-ac 0
      } catch {} };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'set_powersheme_disk_timeout';
      script = {  try { $Local:ErrorActionPreference = "CONTINUE"
        powercfg.exe -change -disk-timeout-ac 0
        powercfg.exe -setacvalueindex 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c 0012ee47-9041-4b5d-9b77-535fba8b1442 6738e2c4-e8a5-4a42-b16a-e040e769756e 0
        powercfg.exe -setdcvalueindex 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c 0012ee47-9041-4b5d-9b77-535fba8b1442 6738e2c4-e8a5-4a42-b16a-e040e769756e 0
      } catch {} };
      pre    = { 1 }; post   = { 1 }; }

  @{ name    =   'install_kb2771431_on_win_62';
      script = {
        # TODO. This is needed to ensure Windows Update lookups are timely and succeed.
        # 'A servicing stack update is available for Windows 8 and Windows Server 2012'
        #   http://support.microsoft.com/kb/2771431
        $Url = Switch -Regex ( $Env:OSArchitecture ) {
          '32' { 'http://download.microsoft.com/download/E/A/8/EA8B764E-CFED-4B27-9830-A278882F920D/Windows8-RT-KB2771431-x86.msu' }
          '64' { 'http://download.microsoft.com/download/4/2/A/42A19755-CBA5-4090-A6B8-8F7DA482114C/Windows8-RT-KB2771431-x64.msu' }
        }
        try { Install-Msu $Url } catch {} # Non-fatal as update is delivered by WU anyway.
      };
      pre    = {
        Assert-IsTrue  { $Env:CurrentVersion -eq 6.2 } 'OS Currentversion != 6.2'
      };
      post   = { 1 }; }

  @{ name    =   'update_windows_update_agent';
      script = {
        # In addition to updating the WUA, this step also resolves the issue
        # described in
        # http://support.microsoft.com/kb/2533552
        # http://support.microsoft.com/kb/976902
        Write-Warning "Update Windows Update Agent"
        Update-WUA -Verbose:$VerbosePreference
        shutdown.exe -r -t 3 -c "WUA update complete, rebooting .."
      };
      pre    = {
        Assert-IsTrue { $Env:CurrentVersion -eq 6.1 }           'OS Currentversion != 6.1'
        Assert-IsTrue { $Env:INSTALL_WINDOWS_UPDATE -eq $True } 'Windows Update disabled'
      }
      post   = { Get-WUAVersion }; }
  @{ name    =   'set_wsus_server';
      script = {
        Write-Warning "Setting WSUS URL to $Env:WSUS_URL"
        Set-WSUSServer -WUServer  $Env:WSUS_URL
      };
      pre    = {
        Assert-IsNotNull { $Env:WSUS_URL }                      'WSUS URL is not defined.'
        Assert-IsTrue { $Env:INSTALL_WINDOWS_UPDATE -eq $True } 'Windows Update disabled.'
      };
      post   = { 1 }; }
  @{ name    =   'set_windows_update_preferences';
      script = {
        Set-WindowsUpdatePreference `
            -AUDisabled:$False `
            -AUNotifyOfDownloadAndInstallation `
            -AutoInstallMinorUpdates:$False `
            -ElevateNonAdmins `
            -EnableFeaturedSoftware:$False `
            -IncludeRecommendedUpdates:$False `
            -NoAutoRebootWithLoggedOnUsers `
            -NoAutoUpdate:$False `
            -UseWUServer
      };
      pre    = {
        Assert-IsTrue { $Env:INSTALL_WINDOWS_UPDATE -imatch 'True' } 'Windows Update disabled.'
      }; post   = { 1 }; }
  @{ name    =   'enable_windows_update';
      script = {
        $WUEnabled=$False;
        while ( -not($WUEnabled) ) {
          try {
            Disable-WindowsUpdate; Enable-WindowsUpdate
            $WUEnabled = $True
          } catch {
            Write-Warning "Error restarting Windows Update Services. $_, ($($Error[0]))"
          }
        }
      };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'install_dotnet35_sp1_on_win8_or_2012';
      pre    = {
        Assert-IsTrue { $Env:INSTALL_DOTNET35 -imatch 'True' }       'DotNet3.5 disabled.'
        Assert-IsTrue { $Env:CurrentVersion -imatch '6\.[23]' } 'OS Version != 6\.[23]'
      };
      script = {
        if (-not(Test-Path "$Env:WINDIR\Microsoft.Net\Framework*\v3*")) {
          $razor_metadata = . .\metadata.ps1
          if ( Test-Path($sxs_dir = Join-Path $razor_metadata.repo_share 'sources\sxs') ) {
            Write-Verbose "Installing .Net 3.5 SP1 from '$sxs_dir' (OS Version: $Env:OSVersion)"
            dism.exe /English /Online /Enable-Feature /FeatureName:NetFx3 /All /Source:$sxs_dir /NoRestart | Write-Verbose
            if     ( $LASTEXITCODE -imatch '^(?:0|3010)$' ) {
              Write-Verbose "Install of .Net3.5 SP1 role successful (exit_code: $LASTEXITCODE). Rebooting to continue .."
              Restart-Computer
            }
            else {
              Write-Warning "dism.exe exited with an unknown exit code '$LASTEXITCODE'. Aborting."
              Restart-Computer
              Throw $ErrMsg # TODO. Does this ever get reached? Left in to fail the task
            }
          }
          else {
            $ErrMsg = "Error, Failed installing .Net 3.5 : SXS dir $sxs_dir not found or unreachable."
            if ( ([Double]$Env:OSVersionMajor) -ge 10 ) {
              # Don't fail this task - we'll try the fallback method next
              Write-Warning "(Windows 10). $ErrMsg"
            }
            else {
              Throw "$ErrMsg"
            }
          }
        }
      };
      post   = { 1 }; }
  @{ name    =   'install_dotnet35_sp1_on_win10';
      pre    = {
        Assert-IsTrue { $Env:INSTALL_DOTNET35 -imatch 'True' }       'DotNet3.5 disabled.'
        Assert-IsTrue { [Int]$Env:OSVersionMajor -ge 10 } 'OS Version < 10'
      };
      script = {
        # TODO, code is duplicated here, refactor this task to merge with the previous
        if (-not(Test-Path "$Env:WINDIR\Microsoft.Net\Framework*\v3*")) {
          $razor_metadata = . .\metadata.ps1
          $dot_net_ondemand_pkg_file = 'microsoft-windows-netfx3-ondemand-package.cab'
          $dot_net_ondemand_pkg_url  = '{0}/{1}/{2}' -f $razor_metadata.repo_url, 'sources/sxs', $dot_net_ondemand_pkg_file

          if ( $req = [System.Net.HttpWebRequest]::Create($dot_net_ondemand_pkg_url) ) {
            # Do a HEAD on the URL before downloading
            $req.Method = "HEAD"
            $response = $req.GetResponse()
            if ( $response.StatusCode -imatch '^OK$' ) {
              $sxs_dir = Join-Path $Env:TEMP 'sxs'
              mkdir -Force $sxs_dir -ea 0 | Out-Null

              (New-Object Net.WebClient).DownloadFile($dot_net_ondemand_pkg_url, (Join-Path $sxs_dir $dot_net_ondemand_pkg_file))

              Write-Verbose "Installing .Net 3.5 SP1 from '$sxs_dir' (OS Version: $Env:OSVersion)"
              dism.exe /English /Online /Enable-Feature /FeatureName:NetFx3 /All /Source:$sxs_dir /NoRestart | Write-Verbose

              if     ( $LASTEXITCODE -imatch '^(?:0|3010)$' ) {
                Write-Verbose "Install of .Net3.5 SP1 role successful (exit_code: $LASTEXITCODE). Rebooting to continue .."
                Restart-Computer
              }
              else {
                Write-Warning "dism.exe exited with an unknown exit code '$LASTEXITCODE'. Rebooting to retry .."
                Restart-Computer
                Throw $ErrMsg # TODO. Does this ever get reached?
              }

            }
            else {
              Throw "Error, .Net3.5 ondemand package not available on razor repo, url '$dot_net_ondemand_pkg_url' : $_"
            }
          }
          else {
            Throw "Error creating HTTPWebRequest while attempting HEAD request on url '$dot_net_ondemand_pkg_url' : $_"
          }
        }
      };
      post   = { 1 }; }
  @{ name    =   'install_dotnet35_on_2008r2';
      pre    = {
        # DotNet 3.5 on 2008R2 is required for
        #   * Set-ScreenResolution
        #   * XenTools
        # Assert-IsTrue { $Env:INSTALL_DOTNET35 -imatch 'True' }       'DotNet3.5 disabled.'
        Assert-IsTrue { $Env:CurrentVersion   -ieq 6.1   }    'OS CurrentVersion != 6.1'
        Assert-IsTrue { $Env:InstallationType -ieq 'Server' } 'OS InstallationType != Server'
      };
      script = {
        if (-not(Test-Path "$Env:WINDIR\Microsoft.Net\Framework*\v3*")) {
          Import-Module ServerManager -Verbose:$VerbosePreference;
          Add-WindowsFeature as-net-framework -Verbose:$VerbosePreference
          Write-Verbose "Install of .Net 3.5 feature completed. Rebooting to continue .."
          Restart-Computer
        }
      };
      post   = { 1 }; }

  @{ name    =   "install_language_packs";
      # N.B: This must come after the installation of .Net 3.5 (if applicable)
      script = {
        $RebootRequired = $False
        foreach ($language_pack in @(ls language_packs/*.cab)) {
          Write-Verbose "Installing language pack : $language_pack (OS Version: $Env:OSVersion)"
          dism.exe /English /Online /Add-Package /PackagePath:$language_pack | Write-Verbose

          if ( $LASTEXITCODE -imatch '^(?:0|3010)$' ) {
            $ErrMsg = "Install of langpack successful (exit_code: $LASTEXITCODE). Rebooting to continue .."
            Write-Verbose $ErrMsg
            $RebootRequired = $True
          }
          else {
            # TODO. If we fail, we potentially end up with an infinite retry loop.
            #       dism logs are in %windir%\log\{dism.log,cbs\cbs.log}
            $ErrMsg  = "Language pack install failed."
            $ErrMsg += "dism.exe exited with an unknown exit code '$LASTEXITCODE'."
            Write-Warning $ErrMsg
            try {
              Write-Warning "Attempting to cleanup image"
              & dism.exe /Online /Cleanup-image /Restorehealth
            } catch {
              Write-Warning "Exception caught running dism cleanup : $_"
            }
            $ErrMsg += "Rebooting to retry."
            Write-Warning $ErrMsg
            sleep 5
            Restart-Computer
            Throw $ErrMsg # TODO. Does this ever get reached?
          }
        }

        if ($RebootRequired) {
          Write-Verbose "Language pack installation complete. Rebooting to continue .."
          Restart-Computer
        }
      };
      pre    = { 1 }; post   = { 1 }; }

  @{ name    =   "apply_l18n_settings-$(Get-Date -uformat %s)";
      script = {
        # TODO, control.exe/intl.cpl does not return a meaningful/accurate error code
        #       and so we may be unable to detect failures. More investigations needed.
        #
        #       The key of this block is set to be dynamic and so different on every run
        #       to attempt a retry on every boot during this stage.
        #
        # Events are generated in the Windows/International section of eventvwr
        if ( Test-Path 'l18n.xml' ) {
          $l18n_xml = '/f:"{0}"' -f (ls l18n.xml).FullName
          Write-Verbose "Applying l18n settings - control.exe 'intl.cpl,,' $l18n_xml"
          control.exe 'intl.cpl,,' $l18n_xml | Write-Verbose
        }
      };
      pre    = { 1 }; post   = { 1 }; }

# @{ name    =   'reboot_machine_post_l18n_settings_application';
#     script = {
#       # If we have language packs installed that are not the current locale, reboot so that
#       # we continue with the l18n settings applied to the System and UI.
#       # This should always be the case if multiple language packs are installed.
#       if ( dism.exe /english /online /get-intl |
#              ?{ $_ -imatch 'Installed Language' } |
#              ?{ $_ -inotmatch "Installed Language.*$((Get-UICulture).Parent.Name)" } ) {
#         shutdown.exe -r -t 2 -c "Language packs not matching current locale found. Rebooting .."
#       }
#     };
#     pre    = { 1 }; post   = { 1 }; }

  @{ name    =   'install_kb2697738_on_windows_7_2008r2';
      pre    = {
        Assert-IsNotTrue { Get-Hotfix -Id KB2697738 -ea 0 }                    'Hotfix KB2697738 is installed'
        Assert-IsTrue    { ([Double](Get-OSVersion).CurrentVersion) -eq 6.1 }  'OS CurrentVersion != 6.1'
        Assert-IsTrue    { dism.exe /english /online /get-intl |
                            ?{ $_ -imatch 'Installed Language' } |
                            ?{ $_ -inotmatch "Installed Language.*$((Get-UICulture).Parent.Name)" }
                         } 'Multiple language packs not installed'
        # Assert-IsNotTrue { (Get-UICulture).Parent.Name -eq 'en' }            'UICulture == en'
      };
      script = {
        # TODO. Workaround to allow for WinRM/PSRemoting to succeed on l18n OSes
        # '"Unable to check the status of the firewall" error message when you run the
        #  "Enable-PSRemoting -force" PowerShell command on a Windows 7-based or 
        #  Windows Server 2008 R2-based computer that uses Czech as the display language'
        #  http://support.microsoft.com/kb/2697738
        $Url = Switch -Regex ( $Env:OSArchitecture ) {
          '32' { 'http://hotfixv4.microsoft.com/Windows 7/Windows Server2008 R2 SP1/sp2/Fix397737/7600/free/446309_intl_i386_zip.exe' }
          '64' { 'http://hotfixv4.microsoft.com/Windows 7/Windows Server2008 R2 SP1/sp2/Fix397737/7600/free/446305_intl_x64_zip.exe'  }
          default { Throw "Unknown OS Architecture for hotfix, $Env:OSArchitecture" }
        }
        $ZipFile = "$PWD\kb2697738-{0}.zip" -f $Env:OSArchitecture
        Write-Verbose "Downloading $Url to $ZipFile"
        (New-Object Net.WebClient).DownloadFile($Url, $ZipFile)
        .\unzip.exe -o -q $ZipFile -d .
        if ( Test-Path ($MsuFile = ls *KB2697738*.msu | Select -Expand FullName) ) {
          mkdir -Force "$PWD\log" | Out-Null
          Write-Warning "Installing MSU $MsuFile"
          Start-Process -Wait 'wusa.exe' @($MsuFile,'/quiet','/norestart','/log:log\kb2697738.log') -NoNewWindow -Verbose:$VerbosePreference
        } else {
          Throw "Unable to find KB2697738 MSU file"
        }
      };
      post   = { Get-HotFix | ?{ $_.HotFixId -imatch '2697738' } }; }

  @{ name    =   "add_powershell_assemblies_to_ngen_queue_pre_windows_update-$(Get-Date -UFormat %s)";
      script = { Add-AssemblyToNgenQueue -CurrentDomainAssemblies -Verbose:$VerbosePreference };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   "start_ngen_queued_tasks_pre_windows_update-$(Get-Date -UFormat %Y%m%d%H)";
      script = {
        # Execute pending ngen tasks before invoking windows update
        # 'Installing updates for the Microsoft .NET Framework 4 can take longer than expected in some scenarios'
        #   http://support.microsoft.com/kb/2570538
        # 'FIX: Computer stops responding when the Mscorsvw.exe process starts in the .NET Framework 4'
        #   http://support.microsoft.com/kb/2571181
        # 'Citrix Virtual Memory Optimization Service can lead to .NET application corruption'
        #   http://support.microsoft.com/kb/2480607
        # TODO. Forcing ngen to execute queued items like this is reported to take up
        #       considerable space on Windows 2012 R2 (and other?) images.
        #       However, not invoking it causes .Net apps/windows update to run slowly.
        Start-NgenQueuedTasks -PriorityLevels 1 -Verbose:$VerbosePreference
      };
      pre    = {
        Assert-IsTrue { $Env:INSTALL_WINDOWS_UPDATE -imatch 'True' } 'Windows Update disabled'
      }; post   = { 1 }; }
  @{ name    =   "start_defrag_on_local_drives_pre_windows_update-$(Get-Date -UFormat %Y%m%d%H)";
      script = {
        # TODO: On PSv2 (win7/2008r2), This can fail with
        #       'Exception calling "Invoke" with "1" arguments(s):
        #       "Process with an Id of X is not running."
        try {
          if ( ([Double]$Env:CurrentVersion) -le 6.1 ) {
            Gwmi Win32_LogicalDisk | ?{ $_.DriveType -eq 3 } | %{ $_.DeviceId } | %{
              Start-Process defrag.exe -ArgumentList @('-f','-v',$_) -wait -NoNewWindow
            }
          }
          if ( ([Double]$Env:CurrentVersion) -ge 6.1 ) {
            Start-Process defrag.exe -ArgumentList @('-c','-f','-h','-u','-v') -wait -NoNewWindow
          }
          if ( ([Double]$Env:CurrentVersion) -ge 6.2 ) {
            Start-Process defrag.exe -ArgumentList @('-c','-f','-h','-u','-v','-o') -wait -NoNewWindow
          }
        } catch {
          Write-Warning "Defrag failed with : $_"
        }
      };
    pre    = {
      Assert-IsTrue { $Env:INSTALL_WINDOWS_UPDATE -imatch 'True' } 'Windows Update disabled'
    }; post   = { 1 }; }
  @{ name    =   "start_defrag_on_local_drives_for_boot_optimization_pre_windows_update-$(Get-Date -Uformat %Y%m%d%H)";
      script = {
        Start-Process defrag.exe -ArgumentList @('-f','-v','-b',$Env:SystemDrive) -wait -NoNewWindow -ea 0
      };
    pre    = { 1 }; post   = { 1 }; }

  @{ name    =   "increase_priority_of_windows_modules_services-$(Get-Date -UFormat %s)";
      script = {
        $Pids = @()
        $Pids += @( Get-Process -Name *TiWorker*,*TrustedInstaller* | Select -Expand Id )
        $Pids += @( Gwmi Win32_Service | ?{ $_.Name -imatch 'trust' } | Select -Expand ProcessId )

        foreach ($Id in $Pids) {
          try {
            Set-ProcessPriority -Id $Id -Priority 'RealTime'
          } catch {
            Write-Warning "Failed to set priority for process '$Id' : $_"
          }
        }
      };
      pre    = {
        Assert-IsTrue { $Env:INSTALL_WINDOWS_UPDATE -imatch 'True' } 'Windows Update disabled'
      }; post   = { 1 }; }
  @{ name    =   'install_windows_updates';
      pre    = {
        Assert-IsTrue { $Env:INSTALL_WINDOWS_UPDATE -imatch 'True' } 'Windows Update disabled.'
      };
      script = {
        if ( $Env:CurrentVersion -eq 6.1 ) {
          # TODO. Workaround for Windows 7/2008.
          #       On Windows 7/2008R2, schedule a shutdown in advance to avoid
          #       WU hanging indefinitely/reverting updates on next boot.
          try {
            try { shutdown.exe -a } catch { }
            $RestartDelay = 3600 * 4
            $RestartTime  = (Get-Date).AddSeconds($RestartDelay).ToString('yyyy-MM-ddTHH:mm:ss')
            shutdown.exe -r -t $RestartDelay -c "Windows Update in progress. A reboot is scheduled for $RestartTime."
          } catch {
            Write-Warning "Failed to initiate a scheduled shutdown : $_"
          }
        }

        try {
          Install-ImportantWindowsUpdates -RebootIfNecessary -Verbose:$VerbosePreference
        } catch {
          Switch -Regex ( $_ ) {
            '8024401C|80072EE2' {
              # HRESULT: 0x8024401C - http://windows.microsoft.com/en-US/windows-8/windows-update-error-0x8024401c
              # HRESULT: 0x80072EE2 - http://windows.microsoft.com/en-gb/windows/windows-update-error-80072ee2
              Write-Warning "Error contacting WU server, restarting computer to retry."
            }
            '8024001E' {
              Write-Warning "Windows Update interrupted."
            }
          }
          Write-Warning "$_"
          sleep 30; Restart-Computer
          Throw $_ # Prevent task from succeeding.
        }
      };
      post   = { shutdown -a }; }
  @{ name    =   'start_windows_defender_service';
      script = { try { Get-Service WinDefend | Set-Service -StartupType Manual -PassThru | Restart-Service } catch {} };
      pre    = {
        Assert-IsTrue { Test-IsWindowsDefenderAvailable } 'Windows Defender not available'
      };
      post   = { 1 }; }
  @{ name    =   'invoke_windows_defender_update';
      script = { try { Invoke-WindowsDefenderUpdate -Verbose:$VerbosePreference } catch {} };
      pre    = {
        Assert-IsTrue { Test-IsWindowsDefenderAvailable } 'Windows Defender not available'
      };
      post   = { 1 }; }
  @{ name    =   'invoke_windows_defender_quick_scan';
      script = { try { Invoke-WindowsDefenderScan -Quick -Verbose:$VerbosePreference } catch {} };
      pre    = {
        Assert-IsTrue { Test-IsWindowsDefenderAvailable } 'Windows Defender not available'
      };
      post   = { 1 }; }
  @{ name    =   'invoke_malicious_software_removal_tool_detect_scan';
      script = { try { Invoke-MSRTScan -DetectOnly -Verbose:$VerbosePreference } catch {} };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'collect_windows_defender_files';
      script = { try { Invoke-WindowsDefenderCommand -MPCmdRunArgs @('-GetFiles') -Verbose:$VerbosePreference } catch {} };
      pre    = {
        Assert-IsTrue { Test-IsWindowsDefenderAvailable } 'Windows Defender not available'
      };
      post   = { 1 }; }
  @{ name    =   'update_powershell_help';
      script = {
        try { Update-Help -Verbose:$VerbosePreference } catch {}
      };
      pre    = {
        Assert-IsTrue { [Int]$Env:PSVersionMajor -ge 3 } 'PowerShell Major Version < 3'
      };
      post   = { 1 }; }
  @{ name    =   'disable_windows_update';
      script = { Disable-WindowsUpdate };
      pre    = { 1 }; post   = { 1 }; }
# @{ name    =   'set_screen_resolution_1024x768';
#   script = { reg.exe query "HKEY_CURRENT_CONFIG\System\CurrentControlSet\Control\VIDEO" | ?{$_} | %{
#                reg.exe query $_ | ?{ $_ } | %{
#                  reg.exe add "$_" /v DefaultSettings.XResolution /t REG_DWORD /d 0x400 /f;
#                  reg.exe add "$_" /v DefaultSettings.YResolution /t REG_DWORD /d 0x300 /f;
#                }
#              }
#           };
#     pre    = { if ( ($Env:CurrentVersion) -ne 6.1 ) { Throw "Not on Windows 7/2008" } };
#     post   = { 1 }; }
  @{ name    =   'set_screen_resolution_to_1024x768';
      script = {
        # Requires .Net 3.5
        SetResolution.exe | %{
          if ( $_ -imatch '^\s*(\d+).*1024.*768.*24.*' ) {
            SetResolution.exe --id $matches[1]
          }
        }
      };
      pre    = {
        Assert-IsTrue { [Double]$Env:CurrentVersion -le 6.1 } 'OS CurrentVersion > 6.1'
        Assert-IsTrue { (Get-DotNetFrameWork -HighestVersion).Version -ge [System.Version]"3.5" } '.Net Version < 3.5'
      };
      post   = { 1 }; }

  @{ name    =  "install_vm_guest_tools-$(Get-Date -Uformat %s)"
      script = {
        # TODO. Xen PV Tools requires .Net 3.5 on Server 2008 R2
        #       And cannot be run before WU on 2008, BSOD results
        $PSFile = @"
          `$Env:PSModulePath="$Env:PSModulePath"
          # TODO, -Global is needed here, why?
          # This also reboots the VM
          Import-Module ModuleUtils  -Global -Force
          Import-Module XenTools     -Global -Force
          Import-Module HyperVIC     -Global -Force
          Import-Module VMWareTools  -Global -Force
          Import-Module VMGuestTools -Global -Force
          Import-Module CDRom        -Global -Force
          # TODO, The InstallStatus flag doesn't necessarily indicate a complete install
          if ( -not((Get-VMGuestToolsStatus).InstallStatus) ) {
            VMGuestTools\Install-VMGuestTools -Verbose
          }
"@
         $VMGTI = (join-path $Env:TEMP 'VMGuestTools.ps1')
         $PSFile | Out-File -Encoding ASCII $VMGTI
         # TODO, workaround scoping issues where the above imports succeed
         #       but none of the functions can be executed.
         #       Workaround for now, launch script in its own process space
         # TODO, Validate the installer has successfully completed before
         #       proceeding, even if installers force reboots.
         try {
           powershell.exe -executionpolicy bypass -file $VMGTI
         } catch {
           # If the process has failed, reboot.
           # TODO: This may react to a false positive.
           # - There is no clear way to discriminate failures from
           #   the installers vs those from powershell.
           # - This fails when there are no CD-ROM drives containing
           #   the installer. An infinite reboot cycle is caused.
           $ErrMsg  = "Failed to install VM Guest Tools : $_"
           $ErrMsg += "$ErrMsg. Rebooting to retry .."
           Write-Warning $ErrMsg
           sleep 15
           Restart-Computer
         }
         # TODO, test installation status before returning
      };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =  'wait_for_vm_guesttools_to_succeed';
      script = {
        Import-Module ModuleUtils  -Global -Force
        Import-Module XenTools     -Global -Force
        Import-Module HyperVIC     -Global -Force
        Import-Module VMWareTools  -Global -Force
        Import-Module VMGuestTools -Global -Force
        Import-Module CDRom        -Global -Force
        $i=0; $MaxTries=30; $Sleep=8; # 240 seconds
        do {
          $ToolsStatus = $False
          try {
            # TODO. XenTools.psm1 fails on this call if tools have not completed installing
            #       Error, 'MajorVersion' cannot be found on this object
            if ( $VMGuestToolsStatus = Get-VMGuestToolsStatus ) {
              if ( $ToolsStatus = $VMGuestToolsStatus.Installed ) {
                break
              }
            }
          } catch {
            Write-Warning "VMGuestTools Status check $i/$MaxTries, $_"
          }
          if ( -not($ToolsStatus) -and ($i -ge 30) ) {
            Write-Warning "VMGuestTools Status not OK after wait"
            Restart-Computer # In the hope that Tools will continue at next boot
          }
          sleep $Sleep
          $i++;
        } while ( -not($ToolsStatus) );
      };
      pre    = { 1 }; post   = { 1 }; }

# # # Configure Service Startup
# # # Application Layer Gateway Service
# # @{ name    =  'set_service__alg';
# #     script = { Set-Service 'ALG' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # Bitlocker Drive Encryption Service
# # @{ name    =  'set_service__bdesvc';
# #     script = { Set-Service 'BDESVC' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # BITS - Background Intelligent Transfer Services
# # @{ name    =  'set_service__bits_startuptype_manual';
# #     script = { Set-Service 'BITS' -StartupType 'Manual' -ea 0 -verb:$VerbosePreference;  };
# #     pre    = { 1 }; post   = { 1 }; }
# Bluetooth Support Service
#   @{ name    =  'set_service__bthserv_startuptype_disabled';
#       script = { Set-Service bthserv -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference;  };
#       pre    = { 1 }; post   = { 1 }; }
# # # Computer Browser Service
# # @{ name    =  'set_service__browser';
# #     script = { Set-Service 'Browser' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # Offline Files
# # @{ name    =  'set_service__cscservice';
# #     script = { Set-Service 'CscService' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
#   # DefragSvc - Optimize Drives
#   @{ name    =  'set_service__defragsvc_optimize_drives_to_startuptype_disabled';
#       script = { Set-Service 'defragsvc' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference;  };
#       pre    = { 1 }; post   = { 1 }; }
# # # Device Association Service
# # @{ name    =  'set_service__deviceassociationservice';
# #     script = { Set-Service 'DeviceAssociationService' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # Diagnostic Policy Services
# # @{ name    =  'set_service__dps';
# #     script = { Set-Service 'DPS' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # Device Setup Manager Service
# # @{ name    =  'set_service__dsmsvc';
# #     script = { Set-Service 'DsmSvc' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # Encrypting File System Service
# # @{ name    =  'set_service__efs';
# #     script = { Set-Service 'EFS' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
#   # ErSvc - Error Reporting
#   @{ name    =  'set_service__ersvc_error_reporting_to_startuptype_manual';
#       script = { Set-Service 'ERSvc' -StartupType 'Manual' -ea 0 -verb:$VerbosePreference;  };
#       pre    = { 1 }; post   = { 1 }; }
#   # Fax Service
#   @{ name    =  'set_service__fax';
#       script = { Set-Service 'Fax' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
#       pre    = { 1 }; post   = { 1 }; }
# # # Function Discovery Resource Publication Service
# # @{ name    =  'set_service__fdrespub';
# #     script = { Set-Service 'FDResPub' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # HelpSvc - Help and Support Service
# # @{ name    =  'set_service__helpsvc_help_and_support_to_startuptype_manual';
# #     script = { Set-Service 'helpsvc' -StartupType 'Manual' -ea 0 -verb:$VerbosePreference;  };
# #     pre    = { 1 }; post   = { 1 }; }
#   # HomeGroup Listener Service
#   @{ name    =  'set_service__homegrouplistener';
#       script = { Set-Service 'HomeGroupListener' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
#       pre    = { 1 }; post   = { 1 }; }
#   # HomeGroup Provider Service
#   @{ name    =  'set_service__homegroupprovider';
#       script = { Set-Service 'HomeGroupProvider' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
#       pre    = { 1 }; post   = { 1 }; }
# # # Microsoft iSCSI Initiator Service
# # @{ name    =  'set_service__msiscsi';
# #     script = { Set-Service 'msiscsi' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # Set Network List Service to Auto
# # @{ name    =  'set_service__netprofm';
# #     script = { Set-Service 'netprofm' -StartupType 'Automatic' };
# #     pre    = { 1 }; post   = { 1 }; }
# # # BranchCache Service
# # @{ name    =  'set_service__peerdistsvc';
# #     script = { Set-Service 'PeerDistSvc' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
#   # RemoteRegistry - Remote Registry
#   @{ name    =  'set_service__remoteregistry_remote_registry_to_startuptype_manual';
#       script = { Set-Service 'RemoteRegistry' -StartupType 'Automatic' -ea 0 -verb:$VerbosePreference;  };
#       pre    = { 1 }; post   = { 1 }; }
# # # Windows Backup Service
# # @{ name    =  'set_service__sdrsvc';
# #     script = { Set-Service 'SDRSVC' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # Sensor Monitoring Service
# # @{ name    =  'set_service__sensrsvc';
# #     script = { Set-Service 'SensrSvc' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # Shell Hardware Detection Service
# # @{ name    =  'set_service__shellhwdetection';
# #     script = { Set-Service 'ShellHWDetection' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # SNMP Trap Service
# # @{ name    =  'set_service__snmptrap';
# #     script = { Set-Service 'SNMPTRAP' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # SSDP Discovery Service
# # @{ name    =  'set_service__ssdpsrv';
# #     script = { Set-Service 'SSDPSRV' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # Secure Socket Tunneling Protocol Service
# # @{ name    =  'set_service__sstpsvc';
# #     script = { Set-Service 'SstpSvc' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # Microsoft Software Shadow Copy Provider Service
# # @{ name    =  'set_service__swprv';
# #     script = { Set-Service 'swprv' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # SuperFetch
# # @{ name    =  'set_service__sysmain';
# #     script = { Set-Service 'SysMain' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
#   # Telephony Service
#   @{ name    =  'set_service__tapisrv';
#       script = { Set-Service 'TapiSrv' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
#       pre    = { 1 }; post   = { 1 }; }
# # # Themes Service
# # @{ name    =  'set_service__themes';
# #     script = { Set-Service 'Themes' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # Distributed Link Tracking Client Service
# # @{ name    =  'set_service__trkwks';
# #     script = { Set-Service 'TrkWks' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # UPnP Device Host Service
# # @{ name    =  'set_service__upnphost';
# #     script = { Set-Service 'upnphost' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # Volume Shadow Copy Service
# # @{ name    =  'set_service__vss';
# #     script = { Set-Service 'VSS' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # Block Level Backup Engine Service
# # @{ name    =  'set_service__wbengine';
# #     script = { Set-Service 'wbengine' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # Windows Connect Now - Config Registrar Service
# # @{ name    =  'set_service__wcncsvc';
# #     script = { Set-Service 'wcncsvc' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # Windows Color System Service
# # @{ name    =  'set_service__wcspluginservice';
# #     script = { Set-Service 'WcsPlugInService' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # Diagnostic Policy Services
# # @{ name    =  'set_service__wdiservicehost';
# #     script = { Set-Service 'WdiServiceHost' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
# # # Diagnostic Policy Services
# # @{ name    =  'set_service__wdisystemhost';
# #     script = { Set-Service 'WdiSystemHost' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
# #     pre    = { 1 }; post   = { 1 }; }
#   # Windows Error Reporting Service
#   @{ name    =  'set_service__wersvc';
#       script = { Set-Service 'WerSvc' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
#       pre    = { 1 }; post   = { 1 }; }
#   # WinDefend - Windows Defender
#   @{ name    =  'set_service__windefend_windows_defender_service_to_startuptype_disabled';
#       script = { Set-Service 'WinDefend' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference;  };
#       pre    = { 1 }; post   = { 1 }; }
#   # WLAN AutoConfig Service
#   @{ name    =  'set_service__wlansvc';
#       script = { Set-Service 'Wlansvc' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
#       pre    = { 1 }; post   = { 1 }; }
#   # Windows Media Player Network Sharing Service
#   @{ name    =  'set_service__wmpnetworksvc';
#       script = { Set-Service 'WMPNetworkSvc' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
#       pre    = { 1 }; post   = { 1 }; }
#   # Family Safety Service
#   @{ name    =  'set_service__wpcsvc';
#       script = { Set-Service 'WPCSvc' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
#       pre    = { 1 }; post   = { 1 }; }
#   # Security Center
#   @{ name    =  'set_service__wscsvc';
#       script = { Set-Service 'wscsvc' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
#       pre    = { 1 }; post   = { 1 }; }
#   # Windows Search Service
#   @{ name    =  'set_service__wsearch';
#       script = { Set-Service 'WSearch' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
#       pre    = { 1 }; post   = { 1 }; }
#   # WSearch - Windows Search
#   @{ name    =  'set_service__wsearch_windows_search_to_startuptype_disabled';
#       script = { Set-Service 'WSearch' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference;  };
#       pre    = { 1 }; post   = { 1 }; }
#   # WuauServ - Automatic Updates
#   @{ name    =  'set_service__wuauserv';
#       script = { Set-Service 'wuauserv' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference;  };
#       pre    = { 1 }; post   = { 1 }; }
#   # WzcSvc - Wireless Autoconfiguration
#   @{ name    =  'set_service__wzcsvc_wireless_to_startuptype_manual';
#       script = { Set-Service 'WZCSVC' -StartupType 'Manual' -ea 0 -verb:$VerbosePreference;  };
#       pre    = { 1 }; post   = { 1 }; }
#   # WWAN AutoConfig Service
#   @{ name    =  'set_service__wwansvc';
#       script = { Set-Service 'WwanSvc' -StartupType 'Disabled' -ea 0 -verb:$VerbosePreference; };
#       pre    = { 1 }; post   = { 1 }; }

  # Scheduled Task Status
  # Application Information Telemetry
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Application_Experience_AitAgent';
      script = { Disable-ScheduledTask "microsoft\windows\Application Experience\AitAgent" -ea 0; };
         pre = { 1 }; post = { 1 }; }
# # Cleans up each package's unused temporary files.
# @{ name    =   'disable_scheduled_task__Microsoft_Windows_ApplicationData_CleanupTemporaryState';
#     script = { Disable-ScheduledTask "\Microsoft\Windows\ApplicationData\CleanupTemporaryState" -ea 0; };
#        pre = { 1 }; post = { 1 }; }
# # Program Telemetry for the Microsoft Customer Experience Program
# @{ name    =   'disable_scheduled_task__Microsoft_Windows_Application_Experience_ProgramDataUpdater';
#     script = { Disable-ScheduledTask "\Microsoft\Windows\Application Experience\ProgramDataUpdater" -ea 0; };
#        pre = { 1 }; post = { 1 }; }
# # Scans startup entries and rasies notification to the user if there are too many startup entries.
# @{ name    =   'disable_scheduled_task__Microsoft_Windows_Application_Experience_StartupAppTask';
#     script = { Disable-ScheduledTask "\Microsoft\Windows\Application Experience\StartupAppTask" -ea 0; };
#        pre = { 1 }; post = { 1 }; }
# # This task collects and uploads autochk SQM data if opted-in to the Microsoft Customer.
# @{ name    =   'disable_scheduled_task__Microsoft_Windows_Autochk_Proxy';
#     script = { Disable-ScheduledTask "\Microsoft\Windows\Autochk\Proxy" -ea 0; };
#        pre = { 1 }; post = { 1 }; }
  # Cleanup Bluetooth Devices
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Bluetooth_UninstallDeviceTask';
      script = { Disable-ScheduledTask "microsoft\windows\Bluetooth\UninstallDeviceTask" -ea 0; };
         pre = { 1 }; post = { 1 }; }
# # NTFS Volume Health Scan
# @{ name    =   'disable_scheduled_task__Microsoft_Windows_Chkdsk_ProactiveScan';
#     script = { Disable-ScheduledTask "\Microsoft\Windows\Chkdsk\ProactiveScan" -ea 0; };
#        pre = { 1 }; post = { 1 }; }
# # Telemtry for the Customer Experience Program
# @{ name    = 'disable_scheduled_task__Microsoft_Windows_Customer Experience Improvement Program_BthSQM';
#     script = { Disable-ScheduledTask '\Microsoft\Windows\Customer Experience Improvement Program\BthSQM' -ea 0 };
#        pre = { 1 }; post = { 1 }; };
# @{ name    = 'disable_scheduled_task__Microsoft_Windows_Customer Experience Improvement Program_Consolidator';
#     script = { Disable-ScheduledTask '\Microsoft\Windows\Customer Experience Improvement Program\Consolidator' -ea 0 };
#        pre = { 1 }; post = { 1 }; };
# @{ name    = 'disable_scheduled_task__Microsoft_Windows_Customer Experience Improvement Program_KernelCeipTask';
#     script = { Disable-ScheduledTask '\Microsoft\Windows\Customer Experience Improvement Program\KernelCeipTask' -ea 0 };
#        pre = { 1 }; post = { 1 }; };
# @{ name    = 'disable_scheduled_task__Microsoft_Windows_Customer Experience Improvement Program_Uploader';
#     script = { Disable-ScheduledTask '\Microsoft\Windows\Customer Experience Improvement Program\Uploader' -ea 0 };
#        pre = { 1 }; post = { 1 }; };
# @{ name    = 'disable_scheduled_task__Microsoft_Windows_Customer Experience Improvement Program_UsbCeip';
#     script = { Disable-ScheduledTask '\Microsoft\Windows\Customer Experience Improvement Program\UsbCeip' -ea 0 };
#        pre = { 1 }; post = { 1 }; };
  # Scans fault-tolerant volumes for fast crash recovery
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Data_Integrity_Scan_Data_Integrity_Scan';
      script = { Disable-ScheduledTask "\Microsoft\Windows\Data Integrity Scan\Data Integrity Scan" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  @{ name    = 'disable_scheduled_task__Microsoft_Windows_Diagnosis_Scheduled';
       script = { Disable-ScheduledTask '\Microsoft\Windows\Diagnosis\Scheduled' -ea 0 };
           pre = { 1 }; post = { 1 }; };
  @{ name    = 'disable_scheduled_task__Microsoft_Windows_DiskDiagnostic_Microsoft-Windows-DiskDiagnosticDataCollector';
      script = { Disable-ScheduledTask '\Microsoft\Windows\DiskDiagnostic\Microsoft-Windows-DiskDiagnosticDataCollector' -ea 0 };
         pre = { 1 }; post = { 1 }; };
  # Windows Defender Scheduled Scan
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Defender_MPIdleBackup';
      script = { Disable-ScheduledTask "\Microsoft\Windows Defender\MPIdleBackup" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # Windows Defender Scheduled Scan
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Defender_MP_Scheduled_Scan';
      script = { Disable-ScheduledTask "\Microsoft\Windows Defender\MP Scheduled Scan" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # This task defragments the computers hard disk drives.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Defrag_ScheduledDefrag';
      script = { Disable-ScheduledTask "\Microsoft\Windows\Defrag\ScheduledDefrag" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # The Windows Scheduled Maintenance Task performs periodic maintenance of the computer system by fixing problems automatically or reporting them through the Action Center.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Diagnosis_Scheduled';
      script = { Disable-ScheduledTask "\Microsoft\Windows\Diagnosis\Scheduled" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # The Windows Disk Diagnostic reports general disk and system information to Microsoft for users participating in the Customer Experience Program.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_DiskDiagnostic_Microsoft-Windows-DiskDiagnosticDataCollector';
      script = { Disable-ScheduledTask "\Microsoft\Windows\DiskDiagnostic\Microsoft-Windows-DiskDiagnosticDataCollector" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # The Microsoft-Windows-DiskDiagnosticResolver warns users about faults reported by hard disks that support the Self Monitoring and Reporting Technology (S.M.A.R.T.) standard. This task is triggered automatically by the Diagnostic Policy Service when a S.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_DiskDiagnostic_Microsoft-Windows-DiskDiagnosticResolver';
      script = { Disable-ScheduledTask "\Microsoft\Windows\DiskDiagnostic\Microsoft-Windows-DiskDiagnosticResolver" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # Protects user files from accidental loss by copying them to a backup location when the system is unattended
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_FileHistory_File_History_maintenance_mode';
      script = { Disable-ScheduledTask "\Microsoft\Windows\FileHistory\File History (maintenance mode)" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # System Assessment Tool Scheduled Scan
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Maintenance_WinSAT';
      script = { Disable-ScheduledTask "\Microsoft\Windows\Maintenance\WinSAT" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # Privileged Media Center Search Reindexing job
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Media_Center_ActivateWindowsSearch';
      script = { Disable-ScheduledTask "\Microsoft\Windows\Media Center\ActivateWindowsSearch" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # Check for Media Center updates.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Media_Center_mcupdate';
      script = { Disable-ScheduledTask "\Microsoft\Windows\Media Center\mcupdate" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # Task for launching the Memory Diagnostic
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_MemoryDiagnostic_CorruptionDetector';
      script = { Disable-ScheduledTask "\Microsoft\Windows\MemoryDiagnostic\CorruptionDetector" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # Task for launching the Memory Diagnostic
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_MemoryDiagnostic_DecompressionFailureDetector';
      script = { Disable-ScheduledTask "\Microsoft\Windows\MemoryDiagnostic\DecompressionFailureDetector" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  @{ name    = 'disable_scheduled_task__Microsoft_Windows_MobilePC_HotStart';
      script = { Disable-ScheduledTask '\Microsoft\Windows\MobilePC\HotStart' -ea 0 };
         pre = { 1 }; post = { 1 }; };
  # Launch language cleanup tool
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_MUI_LPRemove';
      script = { Disable-ScheduledTask "\Microsoft\Windows\MUI\LPRemove" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  @{ name    = 'disable_scheduled_task__Microsoft_Windows_Power Efficiency Diagnostic_AnalyzeSystem';
      script = { Disable-ScheduledTask '\Microsoft\Windows\Power Efficiency Diagnostic\AnalyzeSystem' -ea 0 };
         pre = { 1 }; post = { 1 }; };
  @{ name    = 'disable_scheduled_task__Microsoft_Windows_RAC_RacTask';
      script = { Disable-ScheduledTask '\Microsoft\Windows\RAC\RacTask' -ea 0 };
         pre = { 1 }; post = { 1 }; };
  @{ name    = 'disable_scheduled_task__Microsoft_Windows_Ras_MobilityManager';
      script = { Disable-ScheduledTask '\Microsoft\Windows\Ras\MobilityManager' -ea 0 };
         pre = { 1 }; post = { 1 }; };
  # This task controls periodic background synchronization of Offline Files when the user is working in an offline mode.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Offline_Files_Background_Synchronization';
      script = { Disable-ScheduledTask "\Microsoft\Windows\Offline Files\Background Synchronization" -ea 0; };
         pre = { 1 }; post = { 1 }; }
# # This job analyzes the system looking for conditions that may cause high energy use.
# @{ name    =   'disable_scheduled_task__Microsoft_Windows_Power_Efficiency_Diagnostics_AnalyzeSystem';
#     script = { Disable-ScheduledTask "\Microsoft\Windows\Power Efficiency Diagnostics\AnalyzeSystem" -ea 0; };
#        pre = { 1 }; post = { 1 }; }
  # Registry Idle Backup Task
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Registry_RegIdleBackup';
      script = { Disable-ScheduledTask "\Microsoft\Windows\Registry\RegIdleBackup" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # Checks group policy for changes relevant to Remote Assistance
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_RemoteAssistance_RemoteAssistanceTask';
      script = { Disable-ScheduledTask "\Microsoft\Windows\RemoteAssistance\RemoteAssistanceTask" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # N/A
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Servicing_StartComponentCleanup';
      script = { Disable-ScheduledTask "\Microsoft\Windows\Servicing\StartComponentCleanup" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # N/A
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_SettingSync_BackgroundUploadTask';
      script = { Disable-ScheduledTask "\Microsoft\Windows\SettingSync\BackgroundUploadTask" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # Index all crawl type start addresses.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Shell_CrawlStartPages';
      script = { Disable-ScheduledTask "\Microsoft\Windows\Shell\CrawlStartPages" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  @{ name    = 'disable_scheduled_task__Microsoft_Windows_Shell_FamilySafetyMonitor';
      script = { Disable-ScheduledTask '\Microsoft\Windows\Shell\FamilySafetyMonitor' -ea 0 };
         pre = { 1 }; post = { 1 }; };
  @{ name    = 'disable_scheduled_task__Microsoft_Windows_Shell_FamilySafetyRefresh';
      script = { Disable-ScheduledTask '\Microsoft\Windows\Shell\FamilySafetyRefresh' -ea 0 };
         pre = { 1 }; post = { 1 }; };
  # This task automatically wakes the computer and then puts it to sleep when automatic wake is turned on for a Windows SideShow-compatible device.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_SideShow_AutoWake';
      script = { Disable-ScheduledTask "\Microsoft\Windows\SideShow\AutoWake" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # This task manages and synchronizes metadata for the installed gadget s on a Windows SideShow-compatible device.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_SideShow_GadgetManager';
      script = { Disable-ScheduledTask "\Microsoft\Windows\SideShow\GadgetManager" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # This task manages the session behavior when multiple user accounts exist on a Windows SideShow-compatible device.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_SideShow_SessionAgent';
      script = { Disable-ScheduledTask "\Microsoft\Windows\SideShow\SessionAgent" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  @{ name    = 'disable_scheduled_task__Microsoft_Windows_SideShow_SystemDataProviders';
      script = { Disable-ScheduledTask '\Microsoft\Windows\SideShow\SystemDataProviders' -ea 0 };
         pre = { 1 }; post = { 1 }; };
  # This task creates regular system protection points.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_SystemRestore_SR';
      script = { Disable-ScheduledTask "\Microsoft\Windows\SystemRestore\SR" -ea 0; };
         pre = { 1 }; post = { 1 }; }
# @{ name    = 'disable_scheduled_task__Microsoft_Windows_UPnP_UPnPHostConfig';
#     script = { Disable-ScheduledTask '\Microsoft\Windows\UPnP\UPnPHostConfig' -ea 0 };
#        pre = { 1 }; post = { 1 }; };
# @{ name    = 'disable_scheduled_task__Microsoft_Windows_WDI_ResolutionHost';
#     script = { Disable-ScheduledTask '\Microsoft\Windows\WDI\ResolutionHost' -ea 0 };
#        pre = { 1 }; post = { 1 }; };
  # This scheduled task notifies the user that Windows Backup has not been configured.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_WindowsBackup_ConfigNotification';
      script = { Disable-ScheduledTask "\Microsoft\Windows\WindowsBackup\ConfigNotification" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  @{ name    = 'disable_scheduled_task__Microsoft_Windows_Windows Filtering Platform_BfeOnServiceStartTypeChange';
      script = { Disable-ScheduledTask '\Microsoft\Windows\Windows Filtering Platform\BfeOnServiceStartTypeChange' -ea 0 };
         pre = { 1 }; post = { 1 }; };
# # This task applies color calibration settings.
# @{ name    =   'disable_scheduled_task__Microsoft_Windows_WindowsColorSystem_Calibration_Loader';
#     script = { Disable-ScheduledTask "\Microsoft\Windows\WindowsColorSystem\Calibration Loader" -ea 0; };
#        pre = { 1 }; post = { 1 }; }
  # Periodic maintenance task.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Windows_Defender_Windows_Defender_Cache_Maintenance';
      script = { Disable-ScheduledTask "\Microsoft\Windows\Windows Defender\Windows Defender Cache Maintenance" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # Periodic cleanup task.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Windows_Defender_Windows_Defender_Cleanup';
      script = { Disable-ScheduledTask "\Microsoft\Windows\Windows Defender\Windows Defender Cleanup" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # Periodic scan task.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Windows_Defender_Windows_Defender_Scheduled_Scan';
      script = { Disable-ScheduledTask "\Microsoft\Windows\Windows Defender\Windows Defender Scheduled Scan" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # Periodic verification task.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Windows_Defender_Windows_Defender_Verification';
      script = { Disable-ScheduledTask "\Microsoft\Windows\Windows Defender\Windows Defender Verification" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # Windows Error Reporting task to process queued reports.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Windows_Error_Reporting_QueueReporting';
      script = { Disable-ScheduledTask "\Microsoft\Windows\Windows Error Reporting\QueueReporting" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # This task updates the cached list of folders and the security permissions on any new files in a users shared media library.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_Windows_Media_Sharing_UpdateLibrary';
      script = { Disable-ScheduledTask "\Microsoft\Windows\Windows Media Sharing\UpdateLibrary" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # Initiates scheduled install of updates on the machine.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_WindowsUpdate_AUScheduledInstall';
      script = { Disable-ScheduledTask "\Microsoft\Windows\WindowsUpdate\AUScheduledInstall" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # This task is used to display notifications to users.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_WindowsUpdate_AUSessionConnect';
      script = { Disable-ScheduledTask "\Microsoft\Windows\WindowsUpdate\AUSessionConnect" -ea 0; };
         pre = { 1 }; post = { 1 }; }
  # This task is used to start the Windows Update service when needed to perform scheduled operations such as scans.
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_WindowsUpdate_Scheduled_Start';
      script = { Disable-ScheduledTask "\Microsoft\Windows\WindowsUpdate\Scheduled Start" -ea 0; };
         pre = { 1 }; post = { 1 }; }
# # Store License Sync
# @{ name    =   'disable_scheduled_task__Microsoft_Windows_WS_Sync_Licenses';
#     script = { Disable-ScheduledTask "\Microsoft\Windows\WS\Sync Licenses" -ea 0; };
#        pre = { 1 }; post = { 1 }; }
# # Store Refresh Banned App List Task
# @{ name    =   'disable_scheduled_task__Microsoft_Windows_WS_WSRefreshBannedAppsListTask';
#     script = { Disable-ScheduledTask "\Microsoft\Windows\WS\WSRefreshBannedAppsListTask" -ea 0; };
#        pre = { 1 }; post = { 1 }; }
  # Windows Store Maintenance Task
  @{ name    =   'disable_scheduled_task__Microsoft_Windows_WS_WSTask';
      script = { Disable-ScheduledTask "\Microsoft\Windows\WS\WSTask" -ea 0; };
         pre = { 1 }; post = { 1 }; }
# # This task uploads Customer Experience Improvement Program (CEIP) data for Portable Devices
# @{ name    =   'disable_scheduled_task__WPD_SqmUpload_S-1-5-21-2937843477-3889217746-2470408325-1001';
#     script = { Disable-ScheduledTask "\WPD\SqmUpload_S-1-5-21-2937843477-3889217746-2470408325-1001" -ea 0; };
#        pre = { 1 }; post = { 1 }; }
# # This task uploads Customer Experience Improvement Program (CEIP) data for Portable Devices
# @{ name    =   'disable_scheduled_task__WPD_SqmUpload_S-1-5-21-2937843477-3889217746-2470408325-500';
#     script = { Disable-ScheduledTask "\WPD\SqmUpload_S-1-5-21-2937843477-3889217746-2470408325-500" -ea 0; };
#        pre = { 1 }; post = { 1 }; }

  # Clear and remove pagefile for defrag/sdelete in the next stage
  @{ name    =   'disable_automatic_managed_pagefile';
      script = { Disable-AutomaticManagedPagefile -Verbose:$VerbosePreference };
      pre    = {
        Assert-IsTrue { [Double]$Env:CurrentVersion -ge 6.0 } 'OS CurrentVersion < 6.0'
      };
      post   = { 1 }; }
  @{ name    =   "pre_sysprep_remove_appx_provisioned_packages-$(Get-Date -Uformat %s)";
      script = {
        # TODO, this is a workaround to get windows 10 TP to sysprep
        # remove/resolve ASAP.
        ipmo AppX;
        Get-AppXPackage -AllUsers | Remove-AppXPackage -Verbose -ea 0
      };
      pre    = {
        Assert-IsTrue { $Env:CurrentVersion -ge 10.0 }   'OS CurrentVersion < 10.0'
        Assert-IsTrue { $Env:ENABLE_SYSPREP -imatch 'True' } 'Sysprep is not enabled'
        Assert-IsTrue { Get-Module -ListAvailable AppX } 'AppX module not available'
      };
      post   = { 1 }; }
  @{ name    =   'enable_clear_pagefile_at_shutdown';
      script = { Enable-ClearPagefileAtShutdown -Verbose:$VerbosePreference };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'delete_pagefiles';
      script = { Get-Pagefile | Remove-Pagefile -Verbose:$VerbosePreference };
      pre    = { 1 }; post   = { 1 }; }

  @{ name    =   'gpupdate_stage_0';
      script = { gpupdate.exe };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'gpupdate_update_force_stage_0';
      script = { gpupdate.exe /force /sync /boot; try { shutdown.exe -a } catch {} finally { sleep 3 }; };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'stage_0_ends';
      script = { try { (New-Object Net.WebClient).DownloadString('<%= stage_done_url('stage_0_ends') %>') } catch{} };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   "reboot_for_stage_0-$(date -uformat %s)";
      script = {
        $ShutdownMsg = "Imagprep Stage 0 Complete - Rebooting to continue .."
        Write-Verbose $ShutdownMsg
        shutdown.exe -r -t 5 -c $ShutdownMsg
      };
      pre    = { 1 }; post   = { 1 }; }
),

# Stage 1
#   Prepare image
#   Cleanup image
#   Prepare for templating
@(
  @{ name    =   'stage_1_begins';
      script = { try { (New-Object Net.WebClient).DownloadString('<%= stage_done_url('stage_1_begins') %>') } catch{} };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'start_w32tm_service_2';
      script = {
        $i = 0
        while ( $i -le 10 ) {
          if ( (Get-Service -Name W32Time).Status -eq 'Running' ) {
            break
          } else {
            Get-Service -Name W32Time | Set-Service -StartupType Automatic -PassThru | Restart-Service
            sleep 3
          }
        }
      };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'set_timezone'; # Will fail on 2008R2 without .Net3.5
      script = { Get-TimeZone -TimeZoneName "${Env:TIMEZONE}" | Set-TimeZone -Verbose:$VerbosePreference };
         pre = { 1 }; post   = { (Gwmi Win32_TimeZone) -imatch "${Env:TIMEZONE}" }; }

  @{ name    =   'add_powershell_assembLies_to_ngen_queue_2';
      script = { Add-AssemblyToNgenQueue -CurrentDomainAssemblies -Verbose:$VerbosePreference };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'start_ngen_queued_tasks_2';
      script = {
        # Execute pending ngen tasks before sealing image
        # 'Installing updates for the Microsoft .NET Framework 4 can take longer than expected in some scenarios'
        #   http://support.microsoft.com/kb/2570538
        # 'FIX: Computer stops responding when the Mscorsvw.exe process starts in the .NET Framework 4'
        #   http://support.microsoft.com/kb/2571181
        # 'Citrix Virtual Memory Optimization Service can lead to .NET application corruption'
        #   http://support.microsoft.com/kb/2480607
        # TODO. Forcing ngen to execute queued items like this is reported to take up
        #       considerable space on Windows 2012 R2 (and other?) images.
        #       However, not invoking it causes .Net apps/windows update to run slowly.
        # Start-NgenQueuedTasks -Update -Force -Verbose:$VerbosePreference
        # Get-ScheduledTask | ?{ $_.TaskName -imatch 'ngen.*critical' } | %{
        #   $Task = $_.TaskName
        #   schtasks.exe /change /enable /tn $Task | Write-Verbose
        #   try { schtasks.exe /run /tn $Task | Write-Verbose } catch {}
        # }
        Get-NgenTask | ?{$_} | %{
          Write-Host -Fore Cyan "[[ $_ ]]"
          & $_ /RuntimeWide /Critical | Write-Verbose
        }
      };
      pre    = { 1 }; post   = { 1 }; }

  @{ name    =   'activate_windows_stage_1';
      script = { Invoke-WindowsActivation };
      pre    = { 1 }; post   = { Get-WindowsActivation }; }
  @{ name    =   'sync_ntp_time_stage_1';
      script = { Sync-W32Time };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   "pre_sysprep_stop_processes-$(Get-Date -Uformat %s)";
      script = {
        Get-Service *home*,*inst*,*app*,*audio*,*fd*,*theme*,*sysmain*,*search* |
          Stop-Service -Verbose:$VerbosePreference
        Get-Process *search*,*onedrive* | Stop-Process -Force -Verbose:$VerbosePreference
      };
      pre    = {
        Assert-IsTrue { $Env:ENABLE_SYSPREP -imatch 'True' } 'Sysprep is not enabled'
      };
      post   = { 1 }; }
  @{ name    =   'uninstall_browserchoice_startup_command';
      pre    = { 1 };
      script = { Get-StartupCommand | ?{ $_.Caption -imatch 'BrowserChoice' } | Uninstall-StartupCommand -Verbose:$VerbosePreference }; post   = { 1 }; }
  @{ name    =   'show_w32tm_status';
      script = { Show-W32tmStatus -Status };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'eject_cdrom_devices_1';
      script = { try { Dismount-CDROMDevice -All -Verbose:$VerbosePreference } catch {} };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'set_console_window_dimensions';
      script = {
          '%SystemRoot%_System32_WindowsPowerShell_v1.0_powershell.exe',
          '%SystemRoot%_SysWOW64_WindowsPowerShell_v1.0_powershell.exe',
          '' | %{
            $target = Join-Path 'HKCU\Console' $_
            reg.exe add "$target" /v WindowSize        /t REG_DWORD /d 0x00190050 /f       | Write-Verbose
            reg.exe add "$target" /v ScreenBufferSize  /t REG_DWORD /d 0x270f0070 /f       | Write-Verbose
            reg.exe add "$target" /v HistoryBufferSize /t REG_DWORD /d 0x000003c0 /f       | Write-Verbose
            reg.exe add "$target" /v FaceName          /t REG_SZ    /d 'Lucida Console' /f | Write-Verbose
          }
      };
      pre    = { 1; }; post   = { 1 }; }

  @{ name    =   'invoke_winmgmt_repository_reset';
      script = { try { Invoke-WinMgmt -ResetRepository }catch{} };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'restart_winmgmt_service_post_reset';
      # wimgmt/wmi is set to startuptype disabled on Win8.1 localized
      script = { Get-Service -Name winmgmt | Set-Service -StartupType Automatic -PassThru | Restart-Service -Verbose:$VerbosePreference };
      pre    = { 1 }; post   = { 1 }; }

  # # NGEN Service
  # @{ name    =   'disable_scheduled_task__Microsoft_Windows_.NET_Framework_.Net_Framework_NGEN_v4.0.30319_Critical';
  #     script = { Disable-ScheduledTask "\Microsoft\Windows\.NET Framework\.Net Framework NGEN v4.0.30319 Critical" -ea 0; };
  #        pre = { 1 }; post = { 1 }; }
  # @{ name    =   'disable_scheduled_task__Microsoft_Windows_.NET_Framework_.Net_Framework_NGEN_v4.0.30319 64_Critical';
  #     script = { Disable-ScheduledTask "\Microsoft\Windows\.NET Framework\.Net Framework NGEN v4.0.30319 64 Critical" -ea 0; };
  #        pre = { 1 }; post = { 1 }; }
  # # NGEN Service
  # @{ name    =   'disable_scheduled_task__Microsoft_Windows_.NET_Framework_.Net_Framework_NGEN_v4.0.30319';
  #     script = { Disable-ScheduledTask "\Microsoft\Windows\.NET Framework\.Net Framework NGEN v4.0.30319" -ea 0; };
  #        pre = { 1 }; post = { 1 }; }
  # @{ name    =   'disable_scheduled_task__Microsoft_Windows_.NET_Framework_.Net_Framework_NGEN_v4.0.30319 64';
  #     script = { Disable-ScheduledTask "\Microsoft\Windows\.NET Framework\.Net Framework NGEN v4.0.30319 64" -ea 0; };
  #        pre = { 1 }; post = { 1 }; }

  @{ name    =   'invoke_winmgmt_repository_verify';
      script = { try { Invoke-WinMgmt -VerifyRepository }catch{} };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'clear_bitsadmin_cache';
      # bitsadmin is not available on some localized OSes??
      script = { try{& bitsadmin.exe /cache /clear} catch{} };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'remove_hiberfil.sys';
      script = {
        try {
          # TODO, fails with error HRESULT 0x80070422 on Win8.1 x86
          Gwmi Win32_LogicalDisk | ?{ $_.DriveType -eq 3 } | ?{
            Test-Path (Join-Path $_.DeviceID 'hiberfil.sys')
          } | %{ rm -Force -Verbose:$VerbosePreference (Join-Path $_.DeviceID 'hiberfil.sys') -ea 0 }
        } catch {}
      };
      pre    = { 1 };
      post   = {
        Gwmi Win32_LogicalDisk | ?{ $_.DriveType -eq 3 } | ?{
          if (Test-Path (Join-Path $_.DeviceID 'hiberfil.sys')) {
            Throw "$($_.DeviceID)\hiberfil.sys found."
          }
        }
      }; }

  @{ name    =   'delete_pagefile_files';
      script = { 'pagefile.sys', 'swapfile.sys' | %{ rm -Force  (Join-Path $Env:SystemDrive $_) -ea 0 } };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'remove_temp_files';
      script = { rm -Force -Verbose:$VerbosePreference -Recurse (Join-Path $Env:TEMP '*') -ea 0};
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'remove_windows_temp_files';
      script = { rm -Force -Verbose:$VerbosePreference -Recurse (Join-Path $Env:WINDIR 'TEMP\*') -ea 0 };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'remove_c_temp_files';
      script = { rm -Force -Verbose:$VerbosePreference -Recurse (Join-Path $Env:SystemDrive 'TEMP\*') -ea 0 };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'remove_windows_downloaded_program_files';
      script = { rm -Force -Verbose:$VerbosePreference -Recurse (Join-Path $Env:WINDIR 'Downloaded Program Files\*') -ea 0 };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'remove_windows_prefetch_files';
      script = { rm -Force -Verbose:$VerbosePreference -Recurse (Join-Path $Env:WINDIR 'Prefetch\*') -ea 0 };
      pre    = { 1 }; post   = { 1 }; }
# @{ name    =   'remove_ntuninstall_files';
#    script = {
#      try {
#        ls -ea 0 -Force (Join-Path $Env:WINDIR '$NT*install*') -Recurse | %{
#          rm -ea 0 -Recurse -Force -Verbose:$VerbosePreference $_
#        }
#      } catch {}
#    };
#    pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'remove_software_distribution_download_files';
      script = {
        Get-Service *inst* | Stop-Service -Verbose:$VerbosePreference -ea 0
        Sleep 5
        try { rm -Force -Recurse (Join-Path $Env:WINDIR 'SoftwareDistribution\Download') } catch {}
      };
      pre    = {
        Assert-IsTrue { Test-Path (Join-Path $Env:WINDIR 'SoftwareDistribution\Download') -ea 0 }
      }; post   = { 1 }; }
  @{ name    =   'remove_windows_installer_patchcache_files';
      script = {
        Get-Service *inst* | Stop-Service -Verbose:$VerbosePreference -ea 0
        Sleep 5
        rm -Force -Verbose:$VerbosePreference -recurse (Join-Path $Env:WINDIR 'Installer\$PatchCache$\*')  -ea 0
      };
      pre    = {
        Assert-IsTrue { Test-Path (Join-Path $Env:WINDIR 'Installer\$PatchCache$') }
      }; post   = { 1 }; }

  @{ name    = 'setup_disk_cleanup_pre_win10_sageset_65535';
      script = {
        try {
          # Setup disk cleanup (cleanmgr.exe) run so that it can be automated later.
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Compress old files'                             /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Internet Cache Files'                           /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Office Setup Files'                             /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Offline Files'                                  /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Remote Desktop Cache Files'                     /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\System Restore'                                 /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Temporary Offline Files'                        /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\WebClient and WebPublisher Cache'               /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
        } catch {}
      }
      pre    = {
        Assert-IsTrue { Get-Command cleanmgr.exe }
        Assert-IsTrue { [Double]$Env:CurrentVersion -le 6.4 } 'OS Version > 6.4'
      };
      post   = { 1 }; }
  @{ name    = 'setup_disk_cleanup_sageset_65535';
      script = {
        try {
          # Setup disk cleanup (cleanmgr.exe) run so that it can be automated later.
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Active Setup Temp Folders'                      /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\BranchCache'                                    /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Content Indexer Cleaner'                        /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Downloaded Program Files'                       /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Memory Dump Files'                              /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Offline Pages Files'                            /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Old ChkDsk Files'                               /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Previous Installations'                         /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Recycle Bin'                                    /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Service Pack Cleanup'                           /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Setup Log Files'                                /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Setup Log Files'                                /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\System error memory dump files'                 /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\System error minidump files'                    /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Temporary Files'                                /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Temporary Setup Files'                          /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Temporary Sync Files'                           /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Thumbnail Cache'                                /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Update Cleanup'                                 /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Upgrade Discarded Files'                        /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\User file versions'                             /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Windows Defender'                               /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Windows Error Reporting Archive Files'          /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Windows Error Reporting Queue Files'            /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Windows Error Reporting System Archive Files'   /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Windows Error Reporting System Queue Files'     /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Windows ESD installation files'                 /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
          reg.exe add 'HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\VolumeCaches\Windows Upgrade Log Files'                      /f /v 'StateFlags65535' /t REG_DWORD /d 0x2
        } catch {}
      }
      pre    = {
        Assert-IsTrue { Get-Command cleanmgr.exe } 'cleanmgr.exe unavailable.'
      };
      post   = { 1 }; }
  @{ name    =   'start_disk_cleanup_sagerun_65535';
      script = { Start-Process cleanmgr.exe -ArgumentList '/sagerun:65535' -Wait -NoNewWindow };
      pre    = {
        Assert-IsTrue { Get-Command cleanmgr.exe } 'cleanmgr.exe unavailable.'
      };
      post   = { 1 }; }

  @{ name    =   'disable_indexing_on_local_drives';
      script = {
        try {
          # TODO, fails with error HRESULT 0x80070422 on Win8.1 x86 french
          Gwmi Win32_LogicalDisk | ?{ $_.DriveType -eq 3 } | %{
            Get-WmiObject Win32_Volume -Filter "DriveLetter='$($_.DeviceID)'" | ?{
              $_.IndexingEnabled
            } | %{
              $_ | Set-WmiInstance -Arguments @{IndexingEnabled=$False} -Verbose:$VerbosePreference
            }
          }
        } catch {}
      };
      pre    = { 1 }; post   = { 1 }; }
# @{ name    =   'start_service_pack_cleanup_tool';
#     script = { Start-Process vsp1cln.exe -ArgumentList '/quiet' -Wait -NoNewWindow };
#     pre    = { Get-Command 'vsp1cln.exe' -ea 1 }; post   = { 1 }; }
# @{ name    =   'start_component_cleanup_tool';
#     script = { Start-Process compcln.exe -argumentlist '/quiet' -wait -NoNewWindow };
#     pre    = { Get-Command 'compcln.exe' -ea 1 }; post   = { 1 }; }
  @{ name    =   'start_dism_component_store_cleanup_analysis';
      script = {
        try {
          Start-Process dism.exe -argumentlist @('/English', '/Online', '/Cleanup-Image', '/AnalyzeComponentStore', '/NoRestart') -wait -NoNewWindow
        } catch {}
      };
      pre    = {
        Assert-IsTrue { Get-Command dism.exe } 'dism.exe unavailable.'
      }; post   = { 1 }; }
# @{ name    =   'start_dism_component_cleanup';
#     script = {
#       # 'Clean Up the WinSxS Folder' https://technet.microsoft.com/en-us/library/dn251565.aspx
#       try {
#         Start-Process dism.exe -argumentlist @('/Online', '/Cleanup-Image', '/StartComponentCleanup' ) -wait -NoNewWindow
#       } catch {}
#       try {
#         Start-Process dism.exe -argumentlist @('/Online', '/Cleanup-Image', '/SPSuperceded' ) -wait -NoNewWindow
#       } catch {}
#       try {
#         Start-Process dism.exe -argumentlist @('/Online', '/Cleanup-Image', '/SPSuperceded', '/HideSP' ) -wait -NoNewWindow
#       } catch {}
#       try {
#         Start-Process dism.exe -argumentlist @('/Online', '/Cleanup-Image', '/StartComponentCleanup', '/ResetBase' ) -wait -NoNewWindow
#       } catch {}
#     };
#     pre    = { Get-Command 'dism.exe' -ea 1 }; post   = { 1 }; }
  @{ name    =   'start_sfc_integrity_check';
      script = { try { Start-SFC -scannow -Verbose:$VerbosePreference } catch {
                        Write-Warning "SFC Failed to complete :$_"
                      }};
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'start_defrag_on_local_drives_2';
      script = {
        if ( ([Double]$Env:CurrentVersion) -le 6.1 ) {
          1..4 | %{
            Gwmi Win32_LogicalDisk | ?{ $_.DriveType -eq 3 } | %{ $_.DeviceId } | %{
              Start-Process defrag.exe -ArgumentList @('-f','-v',$_) -wait -NoNewWindow
            }
          }
        }
        if ( ([Double]$Env:CurrentVersion) -ge 6.1 ) {
          Start-Process defrag.exe -ArgumentList @('-c','-f','-h','-u','-v') -wait -NoNewWindow
        }
        if ( ([Double]$Env:CurrentVersion) -ge 6.2 ) {
          Start-Process defrag.exe -ArgumentList @('-c','-f','-h','-u','-v','-o') -wait -NoNewWindow
        }
      };
    pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'start_defrag_on_local_drives_for_boot_optimization';
      script = {
        Start-Process defrag.exe -ArgumentList @('-f','-v','-b',$Env:SystemDrive) -wait -NoNewWindow
      };
    pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'set_defragsvc_startuptype_manual';
      script = {
        Get-Service defragsvc -ea 0 | Set-Service -StartupType Manual -PassThru | Restart-Service -Verbose:$VerbosePreference
      };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'drain_idle_task_queue';
      script = {
        # Requests the system run the maintenance tasks scheduled to run when the system is idle.
        # 'Support::ProcessIdleTasks method (Windows)'
        #   https://msdn.microsoft.com/en-us/library/windows/desktop/hh449579%28v=vs.85%29.aspx
        Rundll32.exe advapi32.dll,ProcessIdleTasks
      };
    pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'install_contig';
      script = {
        reg.exe add HKCU\SOFTWARE\Sysinternals\C /v EulaAccepted /t REG_DWORD /d 1 /f
      };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'start_contig_on_local_drives';
      script = {
        Gwmi Win32_LogicalDisk | ?{ $_.DriveType -eq 3 } | %{ & contig.exe -a -s "$($_.DeviceID)" }
      };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'start_contig_on_local_drives_special_ntfs_files';
      script = {
        Gwmi Win32_LogicalDisk | ?{ $_.DriveType -eq 3 } | %{
          $Drive = $_.DeviceID
          '$mft','$LogFile','$Volume','$Attrdef','$Bitmap','$Boot','$BadClus','$Secure','$UpCase','$Extend' | %{
            & contig.exe -v -s (Join-Path $Drive $_)
          }
        }
      };
      pre    = { 1 }; post   = { 1 }; }

# # ATTENTION: Using precompact/sdelete to zero out free space has the effect
# #            of inflating the size of the vdisk to 100% of potential capacity when
# #            using thin-provisioned storage. Use with care.
# @{ name    =   'start_precompact';
#     script = {
#       cp -force -Verbose:$VerbosePreference (@(gcm precompact.exe)[0].Definition) $Env:TEMP
#       Start-Process "$Env:TEMP\precompact.exe" -argumentlist '-silent' -wait -NoNewWindow
#       rm -Force "$Env:TEMP\precompact.exe" -Verbose:$VerbosePreference
#     };
#     pre    = { Get-Command 'precompact.exe' -ea 1 }; post   = { 1 }; }
# @{ name    =   'install_sdelete';
#    script = {
#      reg.exe add 'HKCU\SOFTWARE\Sysinternals\SDelete' /v EulaAccepted /t REG_DWORD /d 1 /f
#    };
#    pre    = { 1 }; post   = { 1 }; }
# @{ name    =   'start_sdelete_to_zero_free_space_on_local_drive';
#     script = {
#       Start-Process 'bin/sdelete.exe' -ArgumentList @('-a', '-c', '-r', '-z', '-p', '3', 'c') -Wait -NoNewWindow
#     };
#     pre    = { 1 }; post   = { 1 }; }

  @{ name    =   'bcdedit_set_bootlog_off';
      script = { bcdedit.exe /set bootlog no };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'bcedit_set_quietboot_on';
      script = { bcdedit.exe /set quietboot on };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'enable_automatic_managed_pagefile';
      script = { Enable-AutomaticManagedPagefile -Verbose:$VerbosePreference };
      pre    = {
        Assert-IsTrue { [Double]$Env:CurrentVersion -ge 6.0 } 'OS Version < 6'
      }; post   = { 1 }; }
  @{ name    =   'disable_clear_pagefile_on_shutdown';
      script = { Disable-ClearPageFileAtShutdown -Verbose:$VerbosePreference };
      pre    = { 1 }; post   = { 1 }; }

  @{ name    =   'initialize_bginfo';
      script = {
        reg.exe add HKCU\SOFTWARE\Sysinternals\BGInfo /v EulaAccepted  /t REG_DWORD /d 1 /f | Write-Verbose
      };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =  'install_bginfo_desktop_startup_script';
      script = {
        $bginfo  = [String]((Resolve-Path (Join-Path $Env:IPBaseDir "bin/bginfo.exe")).ProviderPath)
        $bgifile = [String]((Resolve-Path (Join-Path $Env:IPBaseDir "conf/*.bgi")).ProviderPath)
        Install-GlobalLogonScript -Name 'UpdateBgInfoOnLogon' -Script "$bginfo /nolicprompt /timer:0 $bgifile" -Verbose:$VerbosePreference
      };
      pre    = { 1 }; post   = { Get-StartupCommand }; }
  @{ name    =   "uninstall_imageprep_startup_script-$(date -uformat %s)";
      pre    = { 1 };
      script = { Get-StartupCommand | ?{ $_.Caption -imatch 'Resume-ImagePrep.cmd' } | Uninstall-StartupCommand -Verbose:$VerbosePreference }; post   = { 1 }; }
  @{ name    =   "install_bootstrap_startup_script-$(date -uformat %s)";
      script = { Install-GlobalLogonScript -ScriptPath (ls Start-BootStrap.cmd).FullName -Verbose:$VerbosePreference };
      pre    = { 1 }; post   = { 1 }; }

  @{ name    =   "sysprep_os-$(Get-Date -Uformat %s)";
      script = {
        Invoke-Sysprep -Generalize -Oobe -Quit -AnswerFile 'sysprep.xml' -Verbose:$VerbosePreference
        1;
      };
      pre    = {
        Assert-IsTrue { $Env:ENABLE_SYSPREP -imatch 'True' } 'Sysprep is not enabled'
      };
      post   = { 1 }; }
  @{ name    =  "clear_event_logs-$(date -uformat %s)";
      script = { Get-EventLog -LogName * | %{ Clear-EventLog -LogName $_.Log -Verbose:$VerbosePreference } };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'enable_administrator_account';
      # This must be done post sysprep.
      # This assumes the localized username is 'administrator', this may not always be the case.
      # However, we do rename the localized administrator to 'administrator' in a previous step.
      script = { net.exe user administrator /active:yes };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'gpupdate_stage_1';
      script = { gpupdate.exe };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'gpupdate_update_force_stage_1';
      script = { gpupdate.exe /force /sync /boot; try { shutdown.exe -a } catch {} finally { sleep 3 }; };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'report_image_id_back_to_razor';
      script = {
        # TODO: This section is quite error prone on win7/2k8r2 if the razor server cannot be resolved
        #       wrapped in try{}catch{} for now
        $ReportStatus = $False; $RetryCount = 0
        while ( -not($ReportStatus) -and ($RetryCount -le 10) ) {
          try {
            # TODO: $ImageId is malformed/contains duplicate info
            if ($ImageId = Get-ImageID) {
              $callback = @"
                (New-Object Net.WebClient).DownloadString('<%= stage_done_url("image_id__{0}") %>')
"@
              $callback = $callback -f $ImageId
              Write-Verbose "  Reporting $ImageId to Razor via $callback"
              iex $callback
              $ReportStatus = $True
            } else {
              Throw "Unable to derive ImageId"
            }
          } catch {
            Write-Warning "Failed to report ImageId to Razor"
          } finally {
            $RetryCount++
          }
        }
      };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   'stage_1_ends';
      script = { try { (New-Object Net.WebClient).DownloadString('<%= stage_done_url('stage_1_ends') %>') } catch{} };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   "flush_dns_cache-$(Get-Date -uformat %s)";
      script = { & ipconfig.exe /flushdns };
      pre    = { 1 }; post   = { 1 }; }
  @{ name    =   "shutdown_for_templating-$(date -uformat %s)";
      script = {
        $ShutdownMsg = "Imagprep Stage 2 Complete - Shutting down for templating"
        # TODO. This step fails on Win7/2008R2, Windows 10. Possibly because
        #       of a shutdown attempt in a previous step.
        while (1) {
          sleep 10
          try {
            Write-Verbose $ShutdownMsg
            try { shutdown.exe -a } catch {}  # -ea 0
            sleep 5
            shutdown.exe -s -c $ShutdownMsg
            sleep 5
            try { shutdown.exe -a } catch {}  # -ea 0
            sleep 5
            Stop-Computer
            sleep 5
            try { shutdown.exe -a } catch {}  # -ea 0
            sleep 5
            Stop-Computer -Force
          } catch {
            Write-Warning "Shutdown attempt failed : $_"
          }
        }
      };
      pre    = { 1 }; post   = { 1 }; }
)

