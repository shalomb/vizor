<?xml version="1.0" encoding="utf-8"?>

<!--

  autogenerated unattended.xml for windows sysprep

                 date : <%= (time = Time.new).strftime("%Y-%m-%dT%H:%M:%S%z") %>
         razor_server : <%= @razor_server = URI.parse(repo_url).host %>
             repo_url : <%= repo_url %>
                 repo : <%= repo_url.split('/').last %>
                 task : <%= task.label %>
          razor_share : <%= @razor_share = 'razor' %>
          description : <%= task.description %>
       answerfile_src : <%= file_url('unattended.xml') %>
       answerfile_src : <%= file_url('') %>
             node_url : <%= node_url %>
                 node : <%= node_url.split('/').last %>
       stage_done_url : <%= stage_done_url('finished') %>

        base          : <%= task.base %>
        boot_seq      : <%= task.boot_seq %>
        os            : <%= task.os %>
        os_version    : <%= task.os_version %>
        name          : <%= task.name %>
        label         : <%= task.label %>
        architecture  : <%= task.architecture %>
        description   : <%= task.description%>

     default_language : <%= node.metadata['default_language']             %>
         architecture : <%= node.metadata['architecture']                 %>
    installation_type : <%= node.metadata['installation_type']            %>
        major_version : <%= node.metadata['major_version']                %>
        minor_version : <%= node.metadata['minor_version']                %>
                build : <%= node.metadata['build']                        %>
   service_pack_level : <%= node.metadata['service_pack_level']           %>
   service_pack_build : <%= node.metadata['service_pack_build']           %>
         display_name : <%= node.metadata['display_name']                 %>
  display_description : <%= node.metadata['display_description']          %>
            languages : <%= node.metadata['languages']                    %>
         product_type : <%= @product_type = node.metadata['product_type'] %>
           winpe_arch : <%= @arch = node.metadata['architecture'].to_s =~ /x86$/i ? 'x86' : 'amd64' %>

-->
<!--
     callback_url : <%= stage_done_url('finished') %>
-->

<unattend xmlns="urn:schemas-microsoft-com:unattend">
  <servicing></servicing>

  <settings pass="windowsPE">

    <component  name="Microsoft-Windows-Setup"
                language="neutral"
                processorArchitecture="<%= @arch %>"
                publicKeyToken="31bf3856ad364e35"
                versionScope="nonSxS"
                xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State"
                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

      <DiskConfiguration>
        <WillShowUI>OnError</WillShowUI>

        <Disk wcm:action="add">
          <DiskID>0</DiskID>
          <WillWipeDisk>true</WillWipeDisk>

          <CreatePartitions>
            <CreatePartition wcm:action="add">
              <Order>1</Order>
              <Type>Primary</Type>
              <Extend>true</Extend>
            </CreatePartition>
          </CreatePartitions>

          <ModifyPartitions>
            <ModifyPartition wcm:action="add">
              <PartitionID>1</PartitionID>
              <Letter>C</Letter>
              <Active>true</Active>
              <Format>NTFS</Format>
              <Label>Windows</Label>
              <Order>1</Order>
            </ModifyPartition>
          </ModifyPartitions>

        </Disk>
      </DiskConfiguration>

      <ImageInstall>
        <OSImage>

          <InstallFrom>
            <MetaData wcm:action="add">
              <Key>/IMAGE/NAME</Key>
              <Value><%= node.metadata['name'] %></Value>
            </MetaData>
          </InstallFrom>

          <InstallTo>
            <DiskID>0</DiskID>
            <PartitionID>1</PartitionID>
          </InstallTo>

          <WillShowUI>OnError</WillShowUI>
          <InstallToAvailablePartition>false</InstallToAvailablePartition>

        </OSImage>
      </ImageInstall>

      <UserData>
        <AcceptEula>true</AcceptEula>
        <FullName><%=     node.metadata['owner']        || 'owner' %></FullName>
        <Organization><%= node.metadata['organization'] || 'organization' %></Organization>
<%=
  if node.metadata.has_key?('product_key')
    <<-eos
        <!-- Product Key from http://technet.microsoft.com/en-us/library/ff793406.aspx -->
        <ProductKey>#{ node.metadata['product_key'] }</ProductKey>
eos
  end
%>
      </UserData>

 <%=
   if node.metadata.key?('driver_path')
     <<-eos
       <component name="Microsoft-Windows-PnpCustomizationsWinPE"
                  processorArchitecture="#{ @arch }"
                  publicKeyToken="31bf3856ad364e35"
                  language="neutral"
                  versionScope="nonSxS"
                  xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
          <DriverPaths>
            <PathAndCredentials wcm:action="add" wcm:keyValue="1">
              <Path>#{node.metadata['driver_path']}</Path>
            </PathAndCredentials>
          </DriverPaths>
       </component>
eos
   end
 %>
    </component>

    <component  name="Microsoft-Windows-International-Core-WinPE" language="neutral" processorArchitecture="<%= @arch %>" publicKeyToken="31bf3856ad364e35" versionScope="nonSxS" xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <SetupUILanguage>
        <WillShowUI>OnError</WillShowUI>
        <UILanguage><%= node.metadata['setup_ui_language']   || node.metadata['default_language'] %></UILanguage>
      </SetupUILanguage>
      <SystemLocale><%= node.metadata['system_locale'] || node.metadata['default_language'] %></SystemLocale>
      <UILanguage><%=   node.metadata['ui_language']   || node.metadata['system_loale'] || node.metadata['default_language'] %></UILanguage>
      <InputLocale><%=  node.metadata['input_locale']  || node.metadata['ui_language']  || node.metadata['default_language'] %></InputLocale>
      <UserLocale><%=   node.metadata['user_locale']   || node.metadata['ui_language']  || node.metadata['default_language'] %></UserLocale>
      <UILanguageFallback>en-US</UILanguageFallback>
    </component>

  </settings> <!-- <settings pass="windowsPE"> -->

  <!-- include sysprep.xml -->
  <!-- <%= @sysprep_context = 'firstboot' %> -->
  <%= render_template('sysprep.xml') %>

  <cpi:offlineImage cpi:source="catalog:z:\<%= node.metadata['install_image'] %>"
                    xmlns:cpi="urn:schemas-microsoft-com:cpi" />

</unattend>
