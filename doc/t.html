<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="pandoc.css" type="text/css" />
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#using-vizor">Using Vizor</a><ul>
<li><a href="#terms-used-in-this-guide">Terms used in this guide</a></li>
</ul></li>
<li><a href="#note">NOTE</a><ul>
<li><a href="#setup-command-autocompletion">Setup Command Autocompletion</a></li>
</ul></li>
<li><a href="#command-discovery">Command discovery</a></li>
<li><a href="#building-vms">Building VMs</a><ul>
<li><a href="#define-iso-repositories">Define ISO Repositories</a></li>
<li><a href="#discover-available-install-images-wim-files">Discover available install images (WIM files)</a></li>
<li><a href="#discover-available-language-packs-lp.cab-files">Discover available language packs (lp.cab files)</a></li>
</ul></li>
<li><a href="#infrastructure-setup">Infrastructure setup</a><ul>
<li><a href="#preparations-for-cloudplatformcloudstack">Preparations for CloudPlatform/CloudStack</a></li>
<li><a href="#preparing-a-xenserver-host-or-pool">Preparing a XenServer host or pool</a></li>
</ul></li>
<li><a href="#setting-up-containers">Setting up containers</a><ul>
<li><a href="#cloudstackcloudplatform-instance-containers">CloudStack/CloudPlatform instance containers</a></li>
<li><a href="#xenserver-vm-containers">XenServer VM containers</a></li>
</ul></li>
<li><a href="#defining-boxes">Defining Boxes</a><ul>
<li><a href="#select-the-candidate-install-image">Select the candidate install image</a></li>
<li><a href="#create-a-box-for-the-given-image.">Create a box for the given image.</a></li>
<li><a href="#build-the-box-in-an-available-container">Build the box in an available container</a></li>
<li><a href="#identifying-metadata-keys">Identifying metadata keys</a></li>
</ul></li>
<li><a href="#converting-vms-to-vm-templates">Converting VMs to VM Templates</a><ul>
<li><a href="#for-cloudstack">For CloudStack</a></li>
<li><a href="#for-xenserver">For XenServer</a></li>
</ul></li>
<li><a href="#batch-operations">Batch operations</a><ul>
<li><a href="#create-.vizor.json">Create <code>~/.vizor.json</code></a></li>
<li><a href="#format-of-vizor.json">Format of <code>vizor.json</code></a></li>
<li><a href="#examples-of-batch-builds">Examples of batch builds</a></li>
</ul></li>
</ul>
</div>
<h1 id="using-vizor">Using Vizor</h1>
<p>This document serves as a how-to to perform automated windows installations on VMs on CloudStack or XenServer and the process of creating templates from VMs afterwards.</p>
<h2 id="terms-used-in-this-guide">Terms used in this guide</h2>
<ul>
<li><p>box</p>
<p>Is an ISO/install image + optional metadata definition (e.g. Win7-x86, Win10beta-x64, etc). A box is defined once and built on one or more container providers.</p></li>
<li><p>container</p>
<p>Is a hypervisor/cloud offering (of RAM, CPU, Networks, Storage, etc) to deploy VMs to build boxes in. An image is associated with one of more boxes.</p></li>
<li><p>metadata</p>
<p>Is the data (runtime parameters) that is used to customize the build of one or more boxes.</p></li>
<li><p>image</p>
<p>Is an install image (e.g. install.wim, boot.wim, etc) contained with an .iso file. An image is associated with one or more boxes.</p></li>
<li><p>instance</p>
<p>Is a virtual machine.</p></li>
<li><p>template</p>
<p>In a virtual machine template in the context of virtual machines instances. In the context of razor, this is a ruby template (.erb).</p></li>
</ul>
<h1 id="note">NOTE</h1>
<blockquote>
<p>The command set here is not fully rationalized and therefore not stable as an API.</p>
</blockquote>
<h2 id="setup-command-autocompletion">Setup Command Autocompletion</h2>
<blockquote>
<p>This is needed to prepare the vizor command for the shell. Without it you may encounter a <code>-bash: vizor: command not found</code> error message.</p>
</blockquote>
<pre><code>source /usr/src/vizor/lib/completion.sh</code></pre>
<h1 id="command-discovery">Command discovery</h1>
<p>Vizor's command tab-completion allows for the user to discover commands pertaining to various operations.</p>
<p>e.g. To discover how cloudstack templates are created</p>
<pre><code>root@vizor:~# vizor &lt;tab&gt;&lt;tab&gt;
batch       bin         box         cloudstack  container   dev         doc         etc
image       instance    iso         lib         razor       README.md   setup       ssh
vizor       windows     xenserver

root@vizor:~# vizor cloudstack &lt;tab&gt;&lt;tab&gt;
cloudmonkey      conf    help.txt         iso              ostype           setup
vm               volume  cloudstack       diskoffering     hypervisor       network
serviceoffering  template         vm-container     zone

root@vizor:~# vizor cloudstack template &lt;tab&gt;&lt;tab&gt;
create    delete    list      template

root@vizor:~# vizor cloudstack template create -h

    vizor cloudstack template create - Create cloudstack templates from instances.

      -d    -- description
      -i    -- instance_name
      -n    -- template_name
      -f    -- is_featured
      -p    -- is_public
      -r    -- name_regex
      -h    -- show_help</code></pre>
<h1 id="building-vms">Building VMs</h1>
<h2 id="define-iso-repositories">Define ISO Repositories</h2>
<p>Atleast one ISO repository is required to be defined in <code>/etc/default/vizor.d/windows_iso_dirs</code></p>
<pre><code>echo &quot;iso cifs://username:password@cifsserver.example.com/isos win7/ win8/&quot; &gt; /etc/default/vizor.d/windows_iso_dirs
echo &quot;iso nfs://nfsserver.example.com/isos                     win7/ win8/&quot; &gt; /etc/default/vizor.d/windows_iso_dirs
echo &quot;iso file:///path/to/isos                                 win7/ win8/&quot; &gt; /etc/default/vizor.d/windows_iso_dirs</code></pre>
<p>The following commands scan the known ISOs to build up the ISO catalog.</p>
<pre><code>vizor windows iso update
vizor iso list</code></pre>
<h2 id="discover-available-install-images-wim-files">Discover available install images (WIM files)</h2>
<p>To discover the available install image provided within the available ISOs</p>
<pre><code>vizor windows image update
vizor image list</code></pre>
<h2 id="discover-available-language-packs-lp.cab-files">Discover available language packs (lp.cab files)</h2>
<p>This is only a requirement when building internationalized/localized VMs where language packs are applied on top of a base locale (e.g. en-US).</p>
<p>This is not required if boxes are defined from fully-localized</p>
<pre><code>vizor windows langpack update
vizor windows langpack list</code></pre>
<h1 id="infrastructure-setup">Infrastructure setup</h1>
<h2 id="preparations-for-cloudplatformcloudstack">Preparations for CloudPlatform/CloudStack</h2>
<p>Use the <a href="https://cwiki.apache.org/confluence/display/CLOUDSTACK/CloudStack+cloudmonkey+CLI#CloudStackcloudmonkeyCLI-Gettingstarted">CloudMonkey Getting Started instructions</a> to set the URL and API/Secret keys for the management server in <code>~/.cloudmonkey/config</code></p>
<p>Additionally, details about the zone are required (later) and so the following may need to be prepared upfront.</p>
<ul>
<li>Service Offerings</li>
<li>Disk Offerings</li>
<li>Guest Networks</li>
<li>Zone Name (If multiple zones exist)</li>
<li>Clusters for hypervisor types (e.g. XenServer, ESX, Hyper-V, etc)</li>
</ul>
<h2 id="preparing-a-xenserver-host-or-pool">Preparing a XenServer host or pool</h2>
<p>Copy the generated ipxe.iso boot image (generated in the vizor setup stage) and helper scripts to Dom0 on the XenServer host.</p>
<pre><code>vizor xenserver -h xshost.example.com -u root -p s3cr3t</code></pre>
<p>Scan the xenserver host for install template definitions, these are used to create the XenServer containers later.</p>
<pre><code>vizor xenserver vm-container scan -h xshost.example.com</code></pre>
<h1 id="setting-up-containers">Setting up containers</h1>
<p>Containers are the VM attribute definions of the hypervisor/cloud provider (Amount of RAM, Numbers of CPUs, Hard Disk Sizes, etc) for the VM instances that a box is built in. e.g. A box to build Windows 2012 Server VM templates for most use-cases requires a container with 2GiB RAM, 20GB Disk Space. Equally, the same box could be used to build VMs for specialized use-case (e.g Databases) and may require a container with 32GiB RAM, 16vCPUs and 2000GB Disk space.</p>
<p>As VMs are sensitive to limits, it is essential that the are created to meet the minimum requirements of the OS to be contained within (at least during the OS installation phase).</p>
<p>Depending on the requirements of the boxes to be built, a number of containers need to be created for each hypervisor or cloud.</p>
<h2 id="cloudstackcloudplatform-instance-containers">CloudStack/CloudPlatform instance containers</h2>
<p>Cloudstack containers take on details of the cloudstack cloud, service offerings, networks, etc that will be used to house the box.</p>
<p>The following creates a CS container in a zone named 'zone01' with the service offerings and hypervisor types of that zone.</p>
<pre><code>vizor container create -t cloudstack \
   -n &#39;zone01-stage-60gbhdd-2vcpu-2gbram-guestnet01&#39; \
   -d &#39;60gb&#39; \
   -s &quot;std.vm 2vcpu 2GB RAM&quot; \
   -z zone01 \
   -N guestnet01 \
   -k us \
   -g imageprep \
   -h XenServer</code></pre>
<p>Refer to the help in <code>vizor container create -t cloudstack -h</code> for additional arguments.</p>
<h2 id="xenserver-vm-containers">XenServer VM containers</h2>
<p>XenServer containers take on details of the XenServer host/pool and the install templates used to build a box in.</p>
<p>This is done by taking one of the XenServer-provided install templates and overridding any of the parameters such as RAM, CPU, etc.</p>
<p>e.g. To install a Windows 7 64-bit VM in a container with</p>
<pre><code>* 2 VCPUs
* 2 GiB RAM
* 100 GiB HDD on the Local Storage SR
* Primary Network Interface on the network named &#39;Public Network&#39;</code></pre>
<p>First select an appropriate container from the cache</p>
<pre><code>vizor xenserver vm-container list  # Make note of the $id</code></pre>
<p>Create the container for vizor</p>
<pre><code>vizor container create -t xenserver -n &#39;my_windows_7_vm_container&#39; \
    -I &quot;Windows_7-x86_64-1_VCPUs-02.00_GiB_RAM-24.00_GiB_HDD&quot; \
    -c 2 \
    -M $((2*1024**3)) \
    -d $((100*1024**3)) \
    -s &#39;Local storage&#39; \
    -N &#39;Public Network&#39; \
    -i ipxe.iso</code></pre>
<p>Refer to the help in <code>vizor container create -t xenserver -h</code> for additional arguments.</p>
<h1 id="defining-boxes">Defining Boxes</h1>
<p>To build a VM, a box definition is required to map an install image to a VM container in the infrastructure provider (hypervisor).</p>
<p>A single box definition can then be used to build the same VM on any of the VM containers known to the system.</p>
<h3 id="select-the-candidate-install-image">Select the candidate install image</h3>
<pre><code>vizor image list                             # Make note of the required image&#39;s ID (i.e. $image_id)</code></pre>
<h3 id="create-a-box-for-the-given-image.">Create a box for the given image.</h3>
<pre><code>vizor box create -i $image_id                # Make note of the returned Id (i.e. $box_id)</code></pre>
<h3 id="build-the-box-in-an-available-container">Build the box in an available container</h3>
<p>Set the box to build in a given infrastructure provider (via the container definition).</p>
<pre><code>vizor box build -b $box_id -c $container_id  # Variables may need to quoted if contents have spaces, etc.</code></pre>
<p>Additionally, razor metadata can be supplied for razor to make use of when evaluating the .erb templates for the razor task used (winpe.task).</p>
<pre><code>declare metadata=&#39;
  { &quot;administrative_password&quot;: &quot;s3cr3t&quot;,
    &quot;windows_timezone&quot;:        &quot;Eastern Standard time&quot;,
    &quot;wsus_url&quot;:                &quot;http://wsus.example.com:8530&quot;,
    &quot;kms_server&quot;:              &quot;kms.example.com&quot;,
    &quot;ntp_server_list&quot;:         &quot;ntp.example.com&quot;,
    &quot;install_dotnet35&quot;:        true,
    &quot;l18n_input_locale&quot;:       &quot;en-US&quot;
  }
&#39;
vizor box build -b $box_id -c $container_id -m &quot;$metadata&quot;</code></pre>
<p>For the most part, vizor will attempt to default most of the metadata to reduce the amount of metadata needed to be supplied at build time.</p>
<h3 id="identifying-metadata-keys">Identifying metadata keys</h3>
<p>To determine which metadata tags to use/override, an inspection of the ruby templates (.erb) in the razor winpe task is needed.</p>
<p>e.g. to list the metadata keys in all the .erb files</p>
<pre><code>root@vizor# cd razor/task/winpe.task/
root@vizor# grep -Ehio &#39;node.metadata[^]]+\]&#39; *.erb | sort -u

node.metadata[&#39;default_locale&#39;]
node.metadata[&#39;input_locale&#39;]
node.metadata[&#39;l18n_input_locale&#39;]
node.metadata[&#39;l18n_system_locale&#39;]
node.metadata[&#39;l18n_user_locale&#39;]
node.metadata[&#39;system_locale&#39;]
node.metadata[&#39;user_locale&#39;]
...</code></pre>
<p>Any of the keys listed here can be overridden by extending the JSON metadata structure to the <code>vizor box build</code> command (example shown above).</p>
<h1 id="converting-vms-to-vm-templates">Converting VMs to VM Templates</h1>
<h2 id="for-cloudstack">For CloudStack</h2>
<p>This works by pattern matching (on the instance name) those instances that require converting to cloudstack templates.</p>
<p>More than one instance can be considered to create templates from, e.g. the following command creates templates for multiple instances that match somewhere in the VM name</p>
<pre><code># 201505 here is part of the VMs&#39; name label
vizor cloudstack template create -f -p -r 201505</code></pre>
<blockquote>
<p>The instances that the templates are created from are not purged/deleted in after this command succeeds and therefore they must be removed separately. The <code>vizor cloudstack vm delete</code> command can be used for that purpose.</p>
</blockquote>
<h2 id="for-xenserver">For XenServer</h2>
<p>As with creating cloudstack templates, a pattern is supplied to the <code>create</code> command to match all those VMs that will be converted to instant templates.</p>
<p>The following command converts all VMs to templates matching a particular pattern somewhere in the VM name-label.</p>
<pre><code>vizor xenserver template create -n &#39;20150204&#39;</code></pre>
<h1 id="batch-operations">Batch operations</h1>
<p>Batch operations allow for multiple boxes to be built at once e.g. for a new set of VM templates for a periodic refresh or to build all VM templates of a particular hypervisor/cloud type.</p>
<h2 id="create-.vizor.json">Create <code>~/.vizor.json</code></h2>
<p><code>~/.vizor.json</code> contains the box-container maps and associated metadata for batch operations to consume.</p>
<p>No tools currently exist to create this file and so must be modelled using the example template <code>batch/vizor.json</code> from the source tree with appropriate edits made.</p>
<pre><code>cp /usr/src/vizor/batch/vizor.json ~/.vizor.json
$EDITOR ~/.vizor.json                  # Make edits as appropriate (see the format section below)
jq -S &#39;.&#39; ~/.vizor.json                # To validate the JSON syntax of the file.</code></pre>
<h2 id="format-of-vizor.json">Format of <code>vizor.json</code></h2>
<p><code>vizor.json</code> is used to contain definitions of boxes, the various containers they can be built in and locales that can be iterated through for every box.</p>
<p>The metadata section contains the metadata key-value pairs that are substituted in the razor (.erb) templates when processes running in the box being prepared request these via the razor web api.</p>
<p>For a list of the keys that can be overridden refer to the <code>Identifying metadata keys</code> section above.</p>
<p>The follow minimal example shows how two box-container-locale definitions are represented with a minimal metadata section.</p>
<pre><code>{
  &quot;metadata&quot; : {
    &quot;administrative_password&quot;: &quot;p455w0rd&quot;,
    &quot;windows_timezone&quot;:        &quot;Eastern Standard Time&quot;,
    &quot;wsus_url&quot;:                &quot;http://wsus2.example.com:8530&quot;,
    &quot;kms_server&quot;:              &quot;kms.example.com&quot;,
    &quot;ntp_server_list&quot;:         &quot;ntp.example.com&quot;,
    &quot;install_dotnet35&quot;:        true,
    &quot;install_windows_update&quot;:  true,
    &quot;l18n_input_locale&quot;:       &quot;en-US&quot;
  },
  &quot;boxes&quot; : {
    &quot;win7_ent-x86-sp1-us-7601&quot;: {
      &quot;container&quot;: {
        &quot;cloudstack-stage&quot;: &quot;stage-xenserver-vlan384-4vCPU-4GB-Large_disk&quot;,
        &quot;cloudstack-prod&quot;:  &quot;production-xenserver-vlan348-4vCPU-4GB-Large_disk&quot;,
        &quot;xenserver-6.2&quot;:    &quot;Windows_7-x86-2_VCPUs-2.00_GiB_RAM-100.00_GiB_HDD-Public&quot;,
        &quot;xenserver-6.5&quot;:    &quot;Windows_7-x86-2_VCPUs-2.00_GiB_RAM-100.00_GiB_HDD-Public&quot;
      },
      &quot;locales&quot;: [ &quot;en-US&quot;, &quot;fr-FR&quot;, &quot;de-DE&quot;, &quot;es-ES&quot;, &quot;ru-RU&quot;,
                   &quot;ja-JP&quot;, &quot;ko-KR&quot;, &quot;zh-CN&quot;, &quot;zh-HK&quot;, &quot;th-TH&quot; ]
    },
    &quot;win7_ent-x64-sp1-us-7601&quot;: {
      &quot;container&quot;: {
        &quot;cloudstack-stage&quot;: &quot;stage-xenserver-vlan384-4vCPU-4GB-Large_disk&quot;,
        &quot;cloudstack-prod&quot;:  &quot;production-xenserver-vlan348-4vCPU-4GB-Large_disk&quot;,
        &quot;xenserver-6.2&quot;:    &quot;Windows_7-x86_64-2_VCPUs-2.00_GiB_RAM-100.00_GiB_HDD-Public&quot;,
        &quot;xenserver-6.5&quot;:    &quot;Windows_7-x86_64-2_VCPUs-2.00_GiB_RAM-100.00_GiB_HDD-Public&quot;
      },
      &quot;locales&quot;: [ &quot;en-US&quot;, &quot;fr-FR&quot;, &quot;de-DE&quot;, &quot;es-ES&quot;, &quot;ru-RU&quot;,
                   &quot;ja-JP&quot;, &quot;ko-KR&quot;, &quot;zh-CN&quot;, &quot;zh-HK&quot;, &quot;th-TH&quot; ]
    }
}</code></pre>
<p>The boxes section requires extending for all the boxes that are candidates for batch operations.</p>
<blockquote>
<p>No schema exists to validate <code>~/.vizor.json</code> and so must be crafted with due care.</p>
</blockquote>
<h2 id="examples-of-batch-builds">Examples of batch builds</h2>
<p>These commands use <code>~/.vizor.json</code> and so require it to be present and populated.</p>
<pre><code>vizor batch build -l &#39;en&#39; -t cloudstack-stage -n  # build all english boxes on the cloudstack-stage containers

vizor batch build -b &#39;win8|w2k12r2&#39; -l &#39;th|kr&#39; -t xenserver-6.5 -n  # build Windows 8.1/2012 R2 boxes for thai/korean on xenserver-6.5

vizor batch build -n                              # build all known boxes across all containers and all locales</code></pre>
</body>
</html>
