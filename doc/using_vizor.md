# Using vizor

This section assumes vizor is [installed](installing_vizor.md) and functional.

## Setup Command Autocompletion

> This is needed to prepare the vizor command for the shell. Without it
> you may encounter a ``-bash: vizor: command not found`` error message.

    source /usr/src/vizor/lib/completion.sh

This command can be set up in ``~/.bashrc`` to make ensure vizor
is available in every shell instance.

## Command discovery

### Command groups

vizor attempts to draw a list of available commands and their synopses
for the user to discover sub-commands pertaining to a particular operation.

e.g. Discovering available XenServer operations

    root@vizor:~# vizor 

    vizor

    Subcommands

        batch                    Build batches of VMs
        bin                      Binaries/Scripts used by vizor.
        box                      Manipulate boxes to build instances/vms.
        cloudstack               Manipulate cloudstack/cloudplatform via cloudmonkey.
        container                Manipulate containers for box building.
        image                    Manipulate the install image catalog.
        instance                 Information about instances/VMs being built.
        iso                      Manipulate object in the ISO catalogue.
        node                     Work with nodes.
        razor                    Task definitions for razor.
        setup                    Setup vizor and necessary components.
        ssh                      SSH scripts/binaries.
        windows                  Work with windows ISOs/Install Images, Language Packs, etc.
        xenserver                Utilities for working with XenServer hosts.

    root@vizor:~# vizor xenserver

    xenserver    Utilities for working with XenServer hosts.

    Subcommands

        host                     Use 'xenserver host' to navigate sub-commands.
        iso-sr                   Use 'xenserver iso-sr' to navigate sub-commands.
        mount                    Mount URLs (NFS, CIFS, etc) on a XenServer host.
        template                 Use 'xenserver template' to navigate sub-commands.
        vm                       Use 'xenserver vm' to navigate sub-commands.
        vm-container             Use 'xenserver vm-container' to navigate sub-commands.

    root@vizor:~# vizor xenserver vm

    vm

    Subcommands

        create
        list                     List VMs on a XenServer host/pool
        reboot                   Manage VMs on a XenServer host/pool
        shutdown                 Manage VMs on a XenServer host/pool
        suspend                  Manage VMs on a XenServer host/pool
        template                 Manage VMs on a XenServer host/pool

    root@vizor:~# vizor xenserver vm shutdown -h

      vizor xenserver vm reboot - Manage VMs on a XenServer host/pool

        -H    -- host
        -n    -- name_regex
        -f    -- force
        -h    -- show_help

### Tab-completion

Vizor's command tab-completion allows for the user to discover commands
in a less obstrusive way.

e.g. To discover how cloudstack templates are created

    root@vizor:~# vizor <tab><tab>
    batch       bin         box         cloudstack  container   dev         doc         etc
    image       instance    iso         lib         razor       README.md   setup       ssh
    vizor       windows     xenserver

    root@vizor:~# vizor cloudstack <tab><tab>
    cloudmonkey      conf    help.txt         iso              ostype           setup
    vm               volume  cloudstack       diskoffering     hypervisor       network
    serviceoffering  template         vm-container     zone

    root@vizor:~# vizor cloudstack template <tab><tab>
    create    delete    list      template

    root@vizor:~# vizor cloudstack template create -h

        vizor cloudstack template create - Create cloudstack templates from instances.

          -d    -- description
          -i    -- instance_name
          -n    -- template_name
          -f    -- is_featured
          -p    -- is_public
          -r    -- name_regex
          -h    -- show_help

## Command Help

Most vizor commands take a help (-h) param that lists options that be supplied.

    root@stage-vizor:~# vizor xenserver template create -h

      vizor xenserver template create - Convert VMs to Instant Templates

        -H    -- host
        -n    -- name_regex
        -h    -- show_help

> Help messages are autogenerated and so may not contain enough detail
 (or in someplaces is lacking).

# Example Uses of vizor

> The below examples are not a comprehensive list of commands. To discover
> additional vizor commands, use the command discovery processes detailed
> above.

### Listing VMs

    vizor cloudstack vm list
    vizor xenserver vm list

### Listing templates

    vizor cloudstack template list
    vizor xenserver template list

### Listing offerings

    vizor cloudstack zone list
    vizor cloudstack network list
    vizor cloudstack serviceoffering list
    vizor xenserver vm-container list

### ISOs, Install Images and Language Packs

    vizor windows iso update
    vizor windows image update
    vizor windows langpack update
    vizor iso list
    vizor image list
    vizor langpack list

### Boxes and containers

    vizor box create -i "$image_id"
    vizor box list

    vizor container create -t xenserver -I Windows_Server_2012_R2-x86_64-1_VCPUs-01.00_GiB_RAM-32.00_GiB_HDD
    vizor container list

### Building VMs

Build a new box in a specififed container

    vizor box list        # Make note of wanted box id
    vizor container list  # Make note of the wanted container id
    vizor box build -b "$box_id" -c "$container_id"

Build the same box but set a password

    vizor box build -b "$box_id" -c "$container_id" -m '{"administrative_password":"S3cr3t"}'

Build the same box but point to an alternative WSUS server

    vizor box build -b "$box_id" -c "$container_id" -m '{"wsus_url":"http://wsus.example.com:8530"}'

Build all win7 VMs marked for the 'en-US' locale in the the cloudstack provider 
(requires a populated ``~/.vizor.json``)

    vizor batch build -b win7 -l 'en-US' -c cloudstack

Build all Win10 boxes for build 10108 on the staging environments
(matching all containers with the pattern 'stage' in them)

    vizor batch build -b 10108 -c stage

Build the same boxes on the production

    vizor batch build -b 10108 -c production

Build all boxes for given locales set, pausing 1 hour between locale sets

    for locale in 'en-US' 'fr-FR' 'de-DE' 'es-ES' 'ru-RU' 'ko-KR'; do
      vizor batch build -l "$locale" -c stage
      sleep 3600
    done

### Converting VMs to templates

Create a new template(s) for the VM instance(s) that matches 
*sql_server_2014_20150520* somewhere in the name. This could match multiple
VM instances.

    vizor cloudstack template create -r 'sql_server_2014__20150520'

Convert to instant VM templates all those VMs that have the string _20150520_ somewhere in the name-label

    vizor xenserver template create -n 20150520

### Exporting templates and root disks for distribution

Export all templates matching '201505' somewhere in the name label to a mount
point on the xenserver.

    vizor xenserver template export xva -m '/mnt/my/disk/export/path' -n 201505

Same as above, except export the .VHD VDisk for the templates.

    vizor xenserver template export vhd -m '/mnt/my/disk/export/path'

